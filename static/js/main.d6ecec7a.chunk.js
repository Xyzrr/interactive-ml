(this["webpackJsonpweb-app"]=this["webpackJsonpweb-app"]||[]).push([[0],{176:function(e,t,n){"use strict";n.r(t);var i=n(1),a=n.n(i),r=n(45),o=n.n(r),s=(n(77),n(67)),c=n(18),l=n(6),h=n(7),d=n(2),u=(n(78),n(19)),f=n.n(u),p=n(10),g=n(50),v=n(4),m=n(5);function y(e){return e.map((function(e,t){return[e,t]})).reduce((function(e,t){return t[0]>e[0]?t:e}))[1]}function w(e,t,n){for(var i=[],a=[];t--;)a.push(n);for(;e--;)i.push(a.slice());return i}function b(e){return e[0].map((function(t,n){return e.map((function(e){return e[n]}))}))}function x(e){return new Promise((function(t){return setTimeout(t,e)}))}function S(e,t,n){if(e.current){e.current.width=t*window.devicePixelRatio,e.current.height=n*window.devicePixelRatio;var i=e.current.getContext("2d");i&&i.scale(window.devicePixelRatio,window.devicePixelRatio)}}var O,k,T,E,j,D,I,H,R,W,A,C,P,G,_=function(){function e(t){Object(v.a)(this,e),this.gamma=void 0,this.lr=void 0,this.eps=void 0,this.epsDecay=void 0,this.qTable=void 0,this.updateData=void 0,t=Object(l.a)({gamma:.95,lr:.1,eps:.5,epsDecay:.99},t),this.gamma=t.gamma,this.lr=t.lr,this.eps=t.eps,this.epsDecay=t.epsDecay}return Object(m.a)(e,[{key:"prepareForEnv",value:function(e){this.qTable=function(e,t){for(var n=[],i=[];t--;)i.push(0);for(;e--;)n.push(i.slice());return n}(e.stateSpace,e.actionSpace)}},{key:"getAction",value:function(e){var t,n;if(null!=this.qTable)return Math.random()<this.eps?(t=0,n=this.qTable[0].length,Math.floor(Math.random()*(n-t))+t):y(this.qTable[e]);console.error("Q learning agent not prepared")}},{key:"update",value:function(e,t,n,i,a){null!=this.qTable?(this.updateData={state:e,action:t,lr:this.lr,reward:i,done:a,gamma:this.gamma,newState:n,nextAction:y(this.qTable[n]),currentQ:this.qTable[e][t],nextQ:Math.max.apply(Math,Object(g.a)(this.qTable[n]))},this.qTable[e][t]+=this.lr*(i+(a?0:this.gamma*Math.max.apply(Math,Object(g.a)(this.qTable[n])))-this.qTable[e][t])):console.error("Q learning agent not prepared")}},{key:"finishEpisode",value:function(){this.eps*=this.epsDecay}}]),e}(),L=n(11),M=n.n(L),F=M.a.rgb(10,10,10),N=M.a.rgb(110,110,110),z=M.a.rgb(200,200,200),Q=(M.a.rgb(224,224,224),M.a.rgb(186,200,146)),V=M.a.rgb(78,201,176),q=M.a.rgb(156,220,254),U=M.a.rgb(86,156,214),B=M.a.rgb(250,138,84),J=M.a.rgb(197,134,192),X=M.a.rgb(220,220,170),K=M.a.rgb(206,145,120),$=M.a.rgb(255,165,0),Y={state:J,nextState:U,reward:X,action:K,nextAction:V,currentQ:M.a.rgb(54,36,17),nextQ:M.a.rgb(17,54,31)},Z=n(62),ee=n.n(Z),te=p.a.div(O||(O=Object(d.a)(["\n  color: ",";\n  font-size: ","px;\n"])),z.toString(),(function(e){return e.fontSize})),ne=function(e){var t=ee.a.renderToString(e.expression);return a.a.createElement(te,{fontSize:e.fontSize||20,dangerouslySetInnerHTML:{__html:t}})},ie=function(e,t){return String.raw(k||(k=Object(d.a)(["colorbox{","}{$","$}"],["\\colorbox{","}{$","$}"])),e.hex(),t)},ae=function(e,t){return String.raw(T||(T=Object(d.a)(["\textcolor{","}{","}"],["\\textcolor{","}{","}"])),e.hex(),t)},re=function(e){var t=e.updateData;if(null==t)return a.a.createElement(a.a.Fragment,null);var n=t.action?String.raw(E||(E=Object(d.a)(["\text{left}"],["\\text{left}"]))):String.raw(j||(j=Object(d.a)(["\text{right}"],["\\text{right}"]))),i=t.nextAction?String.raw(D||(D=Object(d.a)(["\text{left}"],["\\text{left}"]))):String.raw(I||(I=Object(d.a)(["\text{right}"],["\\text{right}"]))),r=ie(Y.currentQ,String.raw(H||(H=Object(d.a)(["Q(",", ",")"])),ae(Y.state,"s"),ae(Y.action,"a"))),o=ie(Y.currentQ,String.raw(R||(R=Object(d.a)(["Q(",", ",")"])),ae(Y.state,t.state.toString()),ae(Y.action,n))),s=ie(Y.nextQ,String.raw(W||(W=Object(d.a)(["max_{","}Q(",", ",")"],["\\max_{","}Q(",", ",")"])),ae(Y.nextAction,"a'"),ae(Y.nextState,"s'"),ae(Y.nextAction,"a'"))),c=ie(Y.nextQ,String.raw(A||(A=Object(d.a)(["Q(",", ",")"])),ae(Y.nextState,t.newState.toString()),ae(Y.nextAction,i.toString())));return a.a.createElement("div",{style:{position:"fixed",left:e.position.x,top:e.position.y}},a.a.createElement(ne,{expression:String.raw(C||(C=Object(d.a)(["\n        \begin{aligned}"," &leftarrow "," + alpha("," + gamma "," - ",") \\ \n        \n        "," &leftarrow "," + ","("," + "," "," - ",") \\ \n        \n        "," &leftarrow "," + ","("," + "," * "," - ",") \\\n\n        "," &leftarrow ","\n        end{aligned}"],["\n        \\begin{aligned}"," &\\leftarrow "," + \\alpha("," + \\gamma "," - ",") \\\\ \n        \n        "," &\\leftarrow "," + ","("," + "," "," - ",") \\\\ \n        \n        "," &\\leftarrow "," + ","("," + "," * "," - ",") \\\\\n\n        "," &\\leftarrow ","\n        \\end{aligned}"])),r,r,ae(Y.reward,"r"),s,r,o,o,t.lr,ae(Y.reward,t.reward.toString()),t.gamma,c,o,o,ie(Y.currentQ,t.currentQ.toFixed(2)),t.lr,ae(Y.reward,t.reward.toString()),t.gamma,ie(Y.nextQ,t.nextQ.toFixed(2)),ie(Y.currentQ,t.currentQ.toFixed(2)),o,(t.currentQ+t.lr*(t.reward+t.gamma*t.nextQ-t.currentQ)).toFixed(2))}))},oe=Object(p.b)(P||(P=Object(d.a)(["\n    from {\n        background: rgba(255, 255, 255, .5);\n    }\n    to {\n        background: rgba(0, 0, 0, 0);\n    }\n"]))),se=p.a.div(G||(G=Object(d.a)(["\n  position: fixed;\n  color: white;\n  padding: 4px 8px;\n  border-radius: 4px;\n  cursor: pointer;\n  user-select: none;\n  animation: "," 0.3s ease-out 1;\n"])),oe),ce=a.a.forwardRef((function(e,t){var n=a.a.useRef(null);return a.a.useImperativeHandle(t,(function(){return{click:function(){n.current&&(n.current.style.animation="none",n.current.offsetWidth,n.current.style.animation="")}}})),a.a.createElement(se,{style:{left:e.position.x,top:e.position.y,animation:"none"},onClick:e.onClick,ref:n},a.a.createElement(ne,{fontSize:16,expression:e.expression}))})),le=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:5,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:.2,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:2,a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:10,r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:100;Object(v.a)(this,e),this.n=void 0,this.slip=void 0,this.small=void 0,this.large=void 0,this.episode_length=void 0,this.state=void 0,this.stepCount=void 0,this.stateSpace=void 0,this.actionSpace=void 0,this.n=t,this.slip=n,this.small=i,this.large=a,this.episode_length=r,this.state=0,this.stepCount=0,this.stateSpace=t,this.actionSpace=2}return Object(m.a)(e,[{key:"step",value:function(e){var t=!1;Math.random()<this.slip&&(e=!e,t=!0);var n=0;return e?(n=this.small,this.state=0):this.state<this.n-1?this.state+=1:n=this.large,this.stepCount+=1,console.log(this.stepCount),{newState:this.state,reward:n,done:this.stepCount>=this.episode_length,info:{slipped:t}}}},{key:"reset",value:function(){return this.state=0,this.stepCount=0,this.state}}]),e}(),he=function(){function e(t,n){Object(v.a)(this,e),this.env=void 0,this.agent=void 0,this.state=void 0,this.prevState=void 0,this.lastReward=void 0,this.totalReward=0,this.lastAction=void 0,this.env=t,this.agent=n,this.reset()}return Object(m.a)(e,[{key:"reset",value:function(){this.state=this.env.reset(),this.prevState=void 0,this.totalReward=0}},{key:"agentTakeAction",value:function(e){var t=this.env.step(e),n=t.newState,i=t.reward,a=t.done,r=t.info;this.lastAction=e,this.lastReward=i,this.totalReward+=i,this.agent.update(this.state,e,n,i,a),this.prevState=this.state,this.state=n;var o=this.totalReward;return a&&(this.agent.finishEpisode(),this.reset()),{action:e,newState:n,reward:i,done:a,totalReward:o,info:r}}},{key:"step",value:function(){var e=this.agent.getAction(this.state);return this.agentTakeAction(e)}}]),e}();var de,ue,fe,pe=n(3),ge=function(){function e(t,n,i,a){Object(v.a)(this,e),this.canvas=t,this.ctx=n,this.size=i,this.sceneObjects=a}return Object(m.a)(e,[{key:"render",value:function(){var e=this;requestAnimationFrame(this.render.bind(this)),this.ctx.fillStyle=F,this.ctx.fillRect(0,0,this.size.width,this.size.height),this.sceneObjects.forEach((function(t){t.render(e.ctx,e.size)})),pe.a.update()}}]),e}(),ve=function(){function e(t){Object(v.a)(this,e),this.position=void 0,this.redness=void 0,this.position=t,this.redness=0}return Object(m.a)(e,[{key:"move",value:function(e){new pe.a.Tween(this.position).to({x:e},150).start()}},{key:"slip",value:function(){this.redness=1,new pe.a.Tween(this).to({redness:0},500).start()}},{key:"render",value:function(e){e.fillStyle=q,e.beginPath(),e.arc(this.position.x,this.position.y,20,0,2*Math.PI),e.fill(),e.fillStyle=B.fade(1-this.redness),e.fill()}}]),e}(),me=function(){function e(t){Object(v.a)(this,e),this.RADIUS=30,this.DIST=100,this.position=t}return Object(m.a)(e,[{key:"highlightStates",value:function(e){this.highlightedStates=e}},{key:"render",value:function(e){var t=this;e.strokeStyle=N,e.lineWidth=1,e.beginPath();for(var n=0;n<5;n++)n<4&&(e.beginPath(),e.moveTo(this.position.x+this.DIST*(n-2)+this.RADIUS,this.position.y),e.lineTo(this.position.x+this.DIST*(n-1)-this.RADIUS,this.position.y)),e.stroke(),e.beginPath(),e.arc(this.position.x+this.DIST*(n-2),this.position.y,this.RADIUS,0,2*Math.PI),e.stroke(),e.font="16px KaTeX_Main",e.fillStyle=N.toString(),e.textAlign="center",e.fillText(n,this.position.x+this.DIST*(n-2),this.position.y+4);this.highlightedStates&&this.highlightedStates.forEach((function(n){e.beginPath(),e.strokeStyle=n.color.toString(),e.arc(t.position.x+t.DIST*(n.index-2),t.position.y,t.RADIUS,0,2*Math.PI),e.stroke(),e.font="16px KaTeX_Main",e.fillStyle=n.color.toString(),e.textAlign="center",e.fillText(n.index,t.position.x+t.DIST*(n.index-2),t.position.y+4)}))}}]),e}(),ye=function(){function e(){Object(v.a)(this,e),this.coins=new Set}return Object(m.a)(e,[{key:"emit",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,i={position:e,opacity:{val:0},fading:!1};this.coins.add(i),new pe.a.Tween(i.position).delay(n).to(t,200).easing(pe.a.Easing.Cubic.Out).start(),new pe.a.Tween(i.opacity).delay(n).to({val:.8},200).easing(pe.a.Easing.Cubic.Out).start()}},{key:"clear",value:function(){var e=this;this.coins.forEach((function(t){t.fading||(new pe.a.Tween(t.opacity).delay(250).to({val:0},400).onComplete((function(){return e.coins.delete(t)})).start(),t.fading=!0)}))}},{key:"render",value:function(e){this.coins.forEach((function(t){e.beginPath(),e.fillStyle=Y.reward.fade(1-t.opacity.val).toString(),e.arc(t.position.x,t.position.y,6,0,2*Math.PI),e.fill()}))}}]),e}(),we=function(){function e(t,n,i){Object(v.a)(this,e),i=Object(l.a)({font:"30px KaTeX_Main",textAlign:"center",precision:2,color:z,modifier:function(e){return e}},i),this.position=t,this.val=n,this.font=i.font,this.textAlign=i.textAlign,this.precision=i.precision,this.modifier=i.modifier,this.color=i.color,this.newVal=0,this.newValColor=B,this.newValOpacity=0,this.newValOffset=0,this.valOpacity=1,this.valOffset=0}return Object(m.a)(e,[{key:"onAnimationFinish",value:function(){this.activeTween=new pe.a.Tween(this).to({newValOpacity:0},2e3).start(),this.valOpacity=1,this.valOffset=0,this.val=this.newVal}},{key:"updateVal",value:function(e){var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:400;e!==this.newVal&&(this.activeTween&&this.activeTween.stop(),t||(this.val=e,this.newVal=e),e>this.val?(this.val=this.newVal,this.newVal=e,this.newValColor=Q,this.valOpacity=1,this.newValOpacity=0,this.valOffset=0,this.newValOffset=-25,this.activeTween=new pe.a.Tween(this).to({valOpacity:0,newValOpacity:1,valOffset:25,newValOffset:0},n).onStop(this.onAnimationFinish.bind(this)).onComplete(this.onAnimationFinish.bind(this)).start()):e<this.val&&(this.val=this.newVal,this.newVal=e,this.newValColor=B,this.valOpacity=1,this.newValOpacity=0,this.valOffset=0,this.newValOffset=25,this.activeTween=new pe.a.Tween(this).to({valOpacity:0,newValOpacity:1,valOffset:-25,newValOffset:0},n).onStop(this.onAnimationFinish.bind(this)).onComplete(this.onAnimationFinish.bind(this)).start()))}},{key:"render",value:function(e){e.textAlign=this.textAlign,e.font=this.font,e.fillStyle=this.color.fade(1-this.valOpacity),null!=this.val&&e.fillText(this.modifier(this.val.toFixed(this.precision)),this.position.x,this.position.y+this.valOffset),e.fillStyle=this.newValColor.fade(1-this.newValOpacity),null!=this.newVal&&e.fillText(this.modifier(this.newVal.toFixed(this.precision)),this.position.x,this.position.y+this.newValOffset)}}]),e}(),be=function(){function e(t,n){Object(v.a)(this,e),this.CELL_WIDTH=120,this.CELL_HEIGHT=70,this.numberObjects=void 0,this.position=void 0,this.highlightedCells=[],this.position=t,this.numberObjects=[];for(var i=0;i<n.length;i++){for(var a=[],r=0;r<n[0].length;r++)a.push(new we(0,0,n[i][r]));this.numberObjects.push(a)}}return Object(m.a)(e,[{key:"updateData",value:function(e){for(var t=0;t<this.numberObjects.length;t++)for(var n=0;n<this.numberObjects[0].length;n++)this.numberObjects[t][n].updateVal(e[t][n])}},{key:"highlightCells",value:function(e){this.highlightedCells=e}},{key:"repositionNumbers",value:function(){for(var e=0;e<this.numberObjects.length;e++)for(var t=0;t<this.numberObjects[0].length;t++)this.numberObjects[e][t].position={x:this.position.x+this.CELL_WIDTH*(t+.5),y:this.position.y+45+this.CELL_HEIGHT*e}}},{key:"render",value:function(e){var t=this;e.lineWidth=1,this.repositionNumbers(),this.highlightedCells&&this.highlightedCells.forEach((function(n){e.beginPath(),e.fillStyle=n.color,e.fillRect(t.position.x+t.CELL_WIDTH*n.col,t.position.y+t.CELL_HEIGHT*n.row,t.CELL_WIDTH,t.CELL_HEIGHT)}));for(var n=0;n<this.numberObjects.length;n++)for(var i=0;i<this.numberObjects[0].length;i++)e.beginPath(),e.rect(this.position.x+this.CELL_WIDTH*i,this.position.y+this.CELL_HEIGHT*n,this.CELL_WIDTH,this.CELL_HEIGHT),e.strokeStyle=N.toString(),e.stroke(),this.numberObjects[n][i].render(e)}}]),e}();function xe(){var e="object"===typeof window,t=a.a.useCallback((function(){return{width:e?window.innerWidth:void 0,height:e?window.innerHeight:void 0}}),[e]),n=a.a.useState(t),i=Object(h.a)(n,2),r=i[0],o=i[1];return a.a.useEffect((function(){if(!e)return!1;function n(){o(t())}return window.addEventListener("resize",n),function(){return window.removeEventListener("resize",n)}}),[t,o,e]),r}var Se={gamma:.95,lr:.1,eps:.5,epsDecay:.99},Oe=180,ke=450,Te=new le,Ee=new _(Se);Ee.prepareForEnv(Te);var je=new he(Te,Ee),De=new we({x:ke,y:Oe-72},0,{textAlign:"center",font:"40px KaTeX_Main",precision:0}),Ie=new me({x:ke,y:Oe}),He=new ye,Re=new ve({x:ke-2*Ie.DIST,y:Oe}),We=new be({x:ke-2.5*Ie.DIST,y:Oe+55},b(Ee.qTable));We.CELL_WIDTH=Ie.DIST;var Ae=p.a.div(de||(de=Object(d.a)(["\n  background-color: ",";\n"])),F.toString());for(var Ce,Pe,Ge,_e=function(){var e=a.a.useRef(null),t=a.a.useRef(),n=xe(),i=a.a.useState(0),r=Object(h.a)(i,2),o=r[0],s=r[1],c=a.a.useState(Object(l.a)({autoPlay:!1},Se)),p=Object(h.a)(c,2),g=p[0],v=p[1];!function(e){var t=a.a.useState(0),n=Object(h.a)(t,2),i=n[0],r=n[1];a.a.useEffect((function(){window.addEventListener("keypress",(function(t){switch(t.keyCode){case 110:e[i](),i<e.length-1&&r(i+1)}}))}))}([function(){window.alert("hello world")},function(){window.alert("hello world 2")}]);var m=function(e,t,n,i){e?E.current&&E.current.click():T.current&&T.current.click(),i.slipped&&Re.slip(),t&&v(Object(l.a)(Object(l.a)({},g),{},{eps:Ee.eps})),s(o+1)},y=function(){var e=je.step(),t=e.action,n=e.done,i=(e.totalReward,e.info);m(t,n,0,i)},w=function(e){if(39===e.keyCode){e.preventDefault();var t=je.agentTakeAction(0),n=t.done,i=(t.totalReward,t.info);m(0,n,0,i)}if(37===e.keyCode){e.preventDefault();var a=je.agentTakeAction(1),r=a.done,o=(a.totalReward,a.info);m(1,r,0,o)}};if(a.a.useEffect((function(){var i=e.current,a=i&&i.getContext("2d");n.width&&n.height&&S(e,n.width,n.height),t.current=new ge(i,a,n,[He,Ie,We,Re,De]),t.current.render()}),[n]),a.a.useEffect((function(){je.reset()}),[]),a.a.useEffect((function(){return document.addEventListener("keydown",w),function(){document.removeEventListener("keydown",w)}})),g.autoPlay&&window.setTimeout(y,200),Ee.gamma=g.gamma,Ee.lr=g.lr,Ee.eps=g.eps,Ee.epsDecay=g.epsDecay,n.width&&n.height&&S(e,n.width,n.height),Re.move(ke+Ie.DIST*((je.state||0)-2)),window.setTimeout((function(){Ee.qTable&&We.updateData(b(Ee.qTable))}),500),window.setTimeout((function(){De.updateVal(je.totalReward)}),150),He.clear(),je.lastReward)for(var x=2===je.lastReward?ke-2*Ie.DIST:ke+2*Ie.DIST,O=0;O<je.lastReward;O++){var k=2*Math.random()*Math.PI;He.emit({x:x,y:Oe},{x:ke+40*Math.cos(k),y:Oe-85+40*Math.sin(k)},150+10*O)}Ee.updateData&&(We.highlightCells([{row:Ee.updateData.action,col:Ee.updateData.state,color:Y.currentQ},{row:Ee.updateData.nextAction,col:Ee.updateData.newState,color:Y.nextQ}]),Ie.highlightStates([{index:Ee.updateData.state,color:Y.state},{index:Ee.updateData.newState,color:Y.nextState}]));var T=a.a.useRef(null),E=a.a.useRef(null);return a.a.createElement(Ae,null,a.a.createElement(f.a,{data:g,onUpdate:function(e){v(e)}},a.a.createElement(u.DatNumber,{path:"lr",label:"Learning rate (\u03b1)",min:0,max:1,step:.01}),a.a.createElement(u.DatNumber,{path:"eps",label:"Rnd chance (\u03b5)",min:0,max:1,step:.01}),a.a.createElement(u.DatNumber,{path:"gamma",label:"Discount rate (\u03b3)",min:0,max:1,step:.01}),a.a.createElement(u.DatNumber,{path:"epsDecay",label:"\u03b5 decay",min:0,max:1,step:.01}),a.a.createElement(u.DatBoolean,{path:"autoPlay",label:"Auto-play"}),a.a.createElement(u.DatButton,{label:"Step",onClick:y})),a.a.createElement("canvas",{style:{width:"100%",height:"100%",background:"black"},ref:e}),a.a.createElement(re,{updateData:Ee.updateData,position:{x:ke-3*We.CELL_WIDTH-12,y:We.position.y+2*We.CELL_HEIGHT+30}}),a.a.createElement(ce,{ref:T,expression:ae(Ee.updateData&&0===Ee.updateData.action?Y.action:Ee.updateData&&0===Ee.updateData.nextAction?Y.nextAction:z,String.raw(ue||(ue=Object(d.a)(["\text{right}"],["\\text{right}"])))),position:{x:ke-3*We.CELL_WIDTH-20,y:We.position.y+20},onClick:function(){var e=je.agentTakeAction(0),t=e.done,n=(e.totalReward,e.info);m(0,t,0,n)}}),a.a.createElement(ce,{ref:E,expression:ae(Ee.updateData&&1===Ee.updateData.action?Y.action:Ee.updateData&&1===Ee.updateData.nextAction?Y.nextAction:z,String.raw(fe||(fe=Object(d.a)(["\text{left}"],["\\text{left}"])))),position:{x:ke-3*We.CELL_WIDTH-20,y:We.position.y+1*We.CELL_HEIGHT+20},onClick:function(){var e=je.agentTakeAction(1),t=e.done,n=(e.totalReward,e.info);m(1,t,0,n)}}))},Le=n(12),Me=n.n(Le),Fe=n(33),Ne=n(65),ze=n.n(Ne),Qe=n(8),Ve=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:9,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:2,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:-1;Object(v.a)(this,e),this.boardSize=void 0,this.foodReward=void 0,this.deathReward=void 0,this.player=void 0,this.food=void 0,this.boardSize=t,this.foodReward=n,this.deathReward=i,this.reset()}return Object(m.a)(e,[{key:"playerOnFood",value:function(){return 2===this.player.gather(this.player.shape[0]).equal(this.food).sum().bufferSync().get(0)}},{key:"playerOutOfBounds",value:function(){var e=this.player.bufferSync(),t=e.get(this.player.shape[0]-1,0),n=e.get(this.player.shape[0]-1,1),i=!(0<=t&&t<this.boardSize&&0<=n&&n<this.boardSize);return i&&console.log("snake went out of bounds"),i}},{key:"collidedWithTail",value:function(){var e=Qe.f(this.player,[this.player.shape[0]-1,1]),t=Object(h.a)(e,2),n=t[0],i=t[1],a=2===Qe.g(n.equal(i),1).max().bufferSync().get(0);return a&&console.log("snake collided with tail"),a}},{key:"step",value:function(e){null==e&&console.log("Error: action was undefined in SnakeEnv!",e);var t=this.player.gather(this.player.shape[0]-1),n=[Qe.h([0,-1]),Qe.h([1,0]),Qe.h([0,1]),Qe.h([-1,0])],i=t.add(n[e]);this.player=this.player.concat(i.reshape([1,2]));var a=0;if(this.playerOnFood())a=this.foodReward,this.randomizeFood();else{var r=Qe.f(this.player,[1,this.player.shape[0]-1]),o=Object(h.a)(r,2)[1];this.player=o}var s=!1;return(this.playerOutOfBounds()||this.collidedWithTail())&&(s=!0,a=this.deathReward),s?{newObservation:Qe.i([this.boardSize,this.boardSize,3]),reward:a,done:s}:{newObservation:this.getObservation(),reward:a,done:s}}},{key:"getObservation",value:function(){var e=this.food.reverse().concat(Qe.h([0])),t=this.player.reverse(1).concat(Qe.a([this.player.shape[0]-1],2).concat(Qe.h([1])).reshape([this.player.shape[0],1]),1),n=e.reshape([1,3]).concat(t),i=Qe.h([1]).concat(Qe.d(1,this.player.shape[0])).concat(Qe.h([1]));return Qe.e(n,i,[this.boardSize,this.boardSize,3])}},{key:"randomizeFood",value:function(){for(;this.food=Qe.c([2],0,this.boardSize,"int32"),2===Qe.g(this.player.equal(this.food),1).max().bufferSync().get(0););}},{key:"reset",value:function(){return this.player=Qe.c([1,2],0,this.boardSize,"int32"),this.randomizeFood(),this.getObservation()}}]),e}(),qe=n(17),Ue=p.a.div(Ce||(Ce=Object(d.a)(["\n  height: 100%;\n  width: 100%;\n  display: flex;\n  flex-direction: column;\n  justify-content: center;\n  .row {\n    display: flex;\n    justify-content: center;\n    height: 60px;\n  }\n  .cell {\n    width: 60px;\n    height: 100%;\n    &.food {\n      background: ",";\n    }\n    &.snake,\n    &.tail {\n      background: ",";\n    }\n  }\n  @media (max-width: 768px) {\n    width: 100%;\n    .row {\n      height: ","vw;\n    }\n    .cell {\n      width: ","vw;\n    }\n  }\n"])),B.desaturate(.3).hex(),Q.desaturate(.5).hex(),100/9,100/9),Be=new Ve,Je=Be.getObservation(),Xe={stopRunning:!1,disableInput:!1,modelUpdating:!1},Ke=function(e){var t=a.a.useState(Je),n=Object(h.a)(t,2),i=n[0],r=n[1],o=a.a.useState(0),s=Object(h.a)(o,2),c=s[0],l=s[1];function d(e,t,n,i,a,r){return u.apply(this,arguments)}function u(){return(u=Object(Fe.a)(Me.a.mark((function e(t,n,i,a,r,o){var s,c,l,h;return Me.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!Xe.modelUpdating){e.next=2;break}return e.abrupt("return");case 2:return Xe.modelUpdating=!0,s=t.predict(n.reshape([1,9,9,3])),c=t.predict(a.reshape([1,9,9,3])),l=r+(o?0:.95*c.max().arraySync()),(h=s.bufferSync()).set(l,0,i),e.next=10,t.fit(n.reshape([1,9,9,3]),h.toTensor(),{epochs:1});case 10:Xe.modelUpdating=!1;case 11:case"end":return e.stop()}}),e)})))).apply(this,arguments)}console.log("Total reward:",c),a.a.useEffect((function(){function e(e){return t.apply(this,arguments)}function t(){return(t=Object(Fe.a)(Me.a.mark((function e(t){var n,i,a,o,s;return Me.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:n=0;case 1:i=!1,a=void 0,a=0===n?Be.getObservation():Be.reset(),o=Me.a.mark((function e(){var n,o,s,c,h,u;return Me.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!Xe.stopRunning){e.next=2;break}return e.abrupt("return",{v:void 0});case 2:return n=t.predict(a.reshape([1,9,9,3])),null==(o=n.argMax(1).arraySync()[0])&&(console.log("Error: action was undefined in runModel!",o),console.log("observation:"),a.print(),console.log("prediction:"),n.print(),console.log("argmax:"),console.log(n.argMax(1))),s=Be.step(o),c=s.newObservation,h=s.reward,u=s.done,r(c),l((function(e){return e+h})),e.next=10,d(t,a,o,c,h,i);case 10:return i=u,a=c,e.next=14,x(300);case 14:case"end":return e.stop()}}),e)}));case 5:if(i){e.next=12;break}return e.delegateYield(o(),"t0",7);case 7:if("object"!==typeof(s=e.t0)){e.next=10;break}return e.abrupt("return",s.v);case 10:e.next=5;break;case 12:n++,e.next=1;break;case 15:case"end":return e.stop()}}),e)})))).apply(this,arguments)}var n=qe.debounce((function(t){Xe.stopRunning=!1,Xe.disableInput=!1,e(t)}),600);Qe.b("/models/snake/model.json").then((function(t){t.compile({optimizer:"adam",loss:"meanSquaredError"}),e(t),window.addEventListener("keydown",(function(e){if(!Xe.disableInput){var i=Be.getObservation(),a={ArrowUp:0,ArrowRight:1,ArrowDown:2,ArrowLeft:3};if(e.key in a){var o=a[e.key],s=Be.step(o),c=s.newObservation,l=s.reward,h=s.done;r(c),Xe.stopRunning=!0,d(t,i,o,c,l,h),h&&(Xe.disableInput=!0,Be.reset()),n(t)}}}))}))}),[]);var f=i.arraySync();return a.a.createElement(Ue,null,f.map((function(e,t){return a.a.createElement("div",{className:"row",key:t},e.map((function(e,t){var n=1===e[0],i=1===e[1],r=e[2]>0;return a.a.createElement("div",{key:t,className:ze()("cell",{food:n,snake:i,tail:r}),style:{opacity:n?.3:i?.4:r?.1+.3*(e[2]-1)/(Be.player.shape[0]-1):0}})})))})))},$e=p.a.div(Pe||(Pe=Object(d.a)(["\n  display: flex;\n  justify-content: center;\n  align-items: center;\n  height: 100%;\n  position: fixed;\n  width: 100%;\n  font-family: Quicksand;\n  .bio {\n    max-width: 400px;\n    width: 100%;\n    padding: 16px;\n    font-size: 18px;\n    margin-bottom: 80px;\n  }\n  .footer {\n    position: absolute;\n    right: 0;\n    bottom: 0;\n    padding: 16px;\n    font-size: 14px;\n    opacity: 0.6;\n    p {\n      margin: 0;\n    }\n  }\n  a {\n    color: black;\n    text-decoration: underline;\n    text-decoration-color: transparent;\n    font-weight: bold;\n    transition: all 0.15s;\n    &:hover {\n      text-decoration-color: black;\n    }\n  }\n"]))),Ye=p.a.div(Ge||(Ge=Object(d.a)(["\n  position: absolute;\n  z-index: -1;\n  width: 100%;\n  height: 100%;\n"]))),Ze=function(e){console.log("props",e);var t={snake:{background:a.a.createElement(Ke,null),link:"https://github.com/Xyzrr/rl-snake",name:"DQN playing Snake"}},n=null;if(window.location.hash&&(n=window.location.hash.substr(1)),!n||!(n in t)){var i=Object.keys(t);n=i[Math.floor(Math.random()*i.length)]}var r=t[n];return a.a.createElement($e,null,a.a.createElement(Ye,null,r.background),a.a.createElement("div",{className:"bio"},a.a.createElement("p",null,"Hey, I'm John. "),a.a.createElement("p",null,"I currently do swe at"," ",a.a.createElement("a",{href:"https://wandb.com/"},"Weights & Biases"),". Earlier I moved buttons around at Google and dropped out of UIUC. I like simplifying and prettifying things,"," ",a.a.createElement("a",{href:"https://blog.johnqian.com"},"writing"),", and doing calisthenics. I idolize Paul Graham and Richard Feynman to an unreasonable extent."),a.a.createElement("p",null,"If you like my work, we should meet up. My email is johnlongqian (at) gmail.com.")),a.a.createElement("div",{className:"footer"},a.a.createElement("p",null,"Background:"),a.a.createElement("p",null,a.a.createElement("a",{href:r.link},r.name))))},et=n(14),tt=n(38),nt=n(66),it=n.n(nt),at=[[[0,0],[0,0],[0,0],[0,0],[0,0]],[[0,0],[0,1],[1,1],[-2,0],[-2,1]],[[0,0],[0,0],[0,0],[0,0],[0,0]],[[0,0],[0,-1],[1,-1],[-2,0],[-2,-1]]],rt=[{color:Q,minos:[[[1,2],[1,3],[2,1],[2,2]]],offsets:at},{color:B,minos:[[[1,1],[1,2],[2,2],[2,3]]],offsets:at},{color:U,minos:[[[1,1],[2,1],[2,2],[2,3]]],offsets:at},{color:$,minos:[[[1,3],[2,1],[2,2],[2,3]]],offsets:at},{color:J,minos:[[[1,2],[2,1],[2,2],[2,3]]],offsets:at},{color:X,minos:[[[1,2],[1,3],[2,2],[2,3]]],offsets:[[[0,0]],[[1,0]],[[1,-1]],[[0,-1]]]},{color:q,minos:[[[2,1],[2,2],[2,3],[2,4]]],offsets:[[[0,0],[0,-1],[0,2],[0,-1],[0,2]],[[0,-1],[0,0],[0,0],[-1,0],[2,0]],[[-1,-1],[-1,1],[-1,-2],[0,1],[0,-2]],[[-1,0],[-1,0],[-1,0],[1,0],[-2,0]]]}],ot=function(e,t){var n,i=[],a=Object(et.a)(e);try{for(a.s();!(n=a.n()).done;){var r=n.value;i.push([r[1],t-r[0]-1])}}catch(o){a.e(o)}finally{a.f()}return i},st=1;st<8;st++)for(var ct=rt[st-1],lt=0;lt<3;lt++)ct.minos.push(ot(ct.minos[lt],5));var ht,dt=function(e,t){return rt[e-1].minos[t]},ut=it()((function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1;return rt[e-1].color.alpha(t).toString()}),{length:2}),ft=function(){function e(){Object(v.a)(this,e),this.WIDTH_HEIGHT_RATIO=.5,this.GUTTER_WIDTH_RATIO=.2,this.enemies=new Set,this.fullWidth=0,this.fullHeight=0,this.gapWidth=0,this.maxEnemyWidth=void 0,this.grid=[],this.enemyWidth=0,this.animatedEnemyWidth=0,this.yOffset=0}return Object(m.a)(e,[{key:"setMaxEnemyWidth",value:function(e){this.maxEnemyWidth=e}},{key:"setEnemyWidth",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;this.enemyWidth=e,0===t?this.animatedEnemyWidth=e:new pe.a.Tween(this).to({animatedEnemyWidth:e},t).easing(pe.a.Easing.Quadratic.InOut).start()}},{key:"getOptimalDimensions",value:function(e){for(var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],n=this.getSideWidth(),i=0,a=0,r=1;;){var o=(i=n/(r+(r+1)*this.GUTTER_WIDTH_RATIO))/this.WIDTH_HEIGHT_RATIO,s=i*this.GUTTER_WIDTH_RATIO;if((a=Math.floor((this.fullHeight-s)/(o+s)))*r>=Math.ceil(e/2))break;r++}for(var c,l,h,d=0,u=0,f=1;;){var p=(d=this.fullHeight/(f+(f+1)*this.WIDTH_HEIGHT_RATIO*this.GUTTER_WIDTH_RATIO))*this.WIDTH_HEIGHT_RATIO,g=p*this.GUTTER_WIDTH_RATIO;if((u=Math.floor((n-g)/(p+g)))*f>=Math.ceil(e/2))break;f++}var v=d*this.WIDTH_HEIGHT_RATIO;return v>i?(c=v,l=f,h=t?2*Math.ceil(e/f/2):2*u):(c=i,l=t?a:Math.ceil(e/(2*r)),h=2*r),this.maxEnemyWidth&&c>this.maxEnemyWidth&&(c=this.maxEnemyWidth),[c,l,h]}},{key:"reshape",value:function(e){console.log("RESHAPING");var t=this.getOptimalDimensions(e.size),n=Object(h.a)(t,3),i=n[0],a=n[1],r=n[2];this.setEnemyWidth(i),this.grid=w(a,r,null),this.enemies=new Set,this.addNewEnemies(e)}},{key:"getGridCapacity",value:function(){return 0===this.grid.length?0:this.grid.length*this.grid[0].length}},{key:"expand",value:function(e){console.log("EXPANDING");for(var t=this.getOptimalDimensions(e),n=Object(h.a)(t,3),i=n[0],a=n[1],r=n[2],o=w(a,r,null),s=0;s<this.grid.length;s++)for(var c=0;c<this.grid[s].length;c++){var l=(r-this.grid[0].length)/2;o[s][c+l]=this.grid[s][c]}this.setEnemyWidth(i,1001),this.grid=o}},{key:"getGutterWidth",value:function(){return this.enemyWidth*this.GUTTER_WIDTH_RATIO}},{key:"getGridExpectedSideWidth",value:function(){if(0===this.grid.length)return 0;var e=this.grid[0].length/2;e:for(var t=0;t<this.grid[0].length/2;t++){for(var n=0;n<this.grid.length;n++)if(null!=this.grid[n][t]||null!=this.grid[n][this.grid[n].length-1-t])break e;e--}return this.enemyWidth*e+this.getGutterWidth()*(e+1)}},{key:"getGridExpectedHeight",value:function(){var e=this.grid.length;e:for(var t=this.grid.length-1;t>0;t--){for(var n=0;n<this.grid[t].length;n++)if(null!=this.grid[t][n])break e;e--}return this.enemyWidth/this.WIDTH_HEIGHT_RATIO*e+this.getGutterWidth()*(e+1)}},{key:"getSideWidth",value:function(){return(this.fullWidth-this.gapWidth)/2}},{key:"updateYOffset",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,t=this.getGridExpectedHeight(),n=(this.fullHeight-t)/2;0===e?this.yOffset=n:new pe.a.Tween(this).to({yOffset:n},e).easing(pe.a.Easing.Quadratic.InOut).start()}},{key:"removeMissingEnemies",value:function(e){for(var t in this.grid)for(var n in this.grid[t]){var i=this.grid[t][n];null==i||e.has(i)||(this.grid[t][n]=null)}}},{key:"addNewEnemies",value:function(e){var t=this.addPath(),n=t.next().value;console.error("ABC attempting with grid",qe.cloneDeep(this.grid)),console.error("enemies",this.enemies,e);var i,a=Object(et.a)(e);try{for(a.s();!(i=a.n()).done;){var r=i.value;if(!this.enemies.has(r)){for(;null!=this.grid[n[0]][n[1]];)n=t.next().value,console.error("ABC coord",n);this.grid[n[0]][n[1]]=r}}}catch(o){a.e(o)}finally{a.f()}}},{key:"sidePath",value:Me.a.mark((function e(t){var n,i,a,r,o;return Me.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(0!==this.grid.length){e.next=2;break}return e.abrupt("return");case 2:n="left"===t?this.grid[0].length/2-1:this.grid[0].length/2,i=0;case 4:if(!(i<Math.max(this.grid.length,this.grid[0].length))){e.next=28;break}if(a=void 0,!((a="left"===t?this.grid[0].length/2-1-i:this.grid[0].length/2+i)>=0&&a<this.grid[0].length)){e.next=16;break}r=0;case 9:if(!(r<i)){e.next=16;break}if(!(r<this.grid.length)){e.next=13;break}return e.next=13,[r,a];case 13:r++,e.next=9;break;case 16:if(!(i<this.grid.length)){e.next=25;break}o=n;case 18:if(!("left"===t?o>=a:o<=a)){e.next=25;break}if(!(o>=0&&o<this.grid[0].length)){e.next=22;break}return e.next=22,[i,o];case 22:o+="left"===t?-1:1,e.next=18;break;case 25:i++,e.next=4;break;case 28:case"end":return e.stop()}}),e,this)}))},{key:"addPath",value:Me.a.mark((function e(){var t,n,i,a,r;return Me.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:t=this.sidePath("left"),n=this.sidePath("right"),i=Object(et.a)(t),e.prev=3,i.s();case 5:if((a=i.n()).done){e.next=13;break}return r=a.value,e.next=9,r;case 9:return e.next=11,n.next().value;case 11:e.next=5;break;case 13:e.next=18;break;case 15:e.prev=15,e.t0=e.catch(3),i.e(e.t0);case 18:return e.prev=18,i.f(),e.finish(18);case 21:case"end":return e.stop()}}),e,this,[[3,15,18,21]])}))},{key:"update",value:function(e,t,n,i){if(console.log("GRID",this.grid),this.gapWidth=i,t!==this.fullWidth||n!==this.fullHeight)return this.fullWidth=t,this.fullHeight=n,this.reshape(e),this.updateYOffset(),void(this.enemies=e);qe.isEqual(this.enemies,e)||(this.removeMissingEnemies(e),e.size>this.getGridCapacity()&&this.expand(e.size),this.addNewEnemies(e),this.updateYOffset(0===this.enemies.size?0:2e3),this.enemies=e)}},{key:"getEnemyCoordinates",value:function(){for(var e={},t=this.fullWidth/2,n=0;n<this.grid.length;n++)for(var i=0;i<this.grid[n].length;i++){var a=this.grid[n][i];if(null!=a){var r=void 0;if(i>=this.grid[n].length/2){var o=i-this.grid[n].length/2;r=t+this.gapWidth/2+o*this.animatedEnemyWidth+(o+1)*this.getGutterWidth()}else{var s=this.grid[n].length/2-1-i;r=t-this.gapWidth/2-(s+1)*(this.animatedEnemyWidth+this.getGutterWidth())}var c=this.yOffset+n*(this.animatedEnemyWidth/this.WIDTH_HEIGHT_RATIO)+(n+1)*this.getGutterWidth();e[a]=[r,c]}}return[e,this.animatedEnemyWidth]}}]),e}(),pt=function(e,t){return[e[0]+t[0],e[1]+t[1]]},gt=function(e,t){return Object(l.a)(Object(l.a)({},e),{},{position:pt(e.position,t)})},vt=function(e,t){var n,i=dt(e.pieceType,e.orientation),a=Object(et.a)(i);try{for(a.s();!(n=a.n()).done;){var r=n.value,o=pt(e.position,r);if(o[0]<0||o[0]>=40||o[1]<0||o[1]>=10||t[o[0]][o[1]])return!0}}catch(s){a.e(s)}finally{a.f()}return!1},mt=function(){function e(t){Object(v.a)(this,e),this.ctx=void 0,this.enemyGrid=void 0,this.enemyStates={},this.playerState=null,this.ctx=t,this.enemyGrid=new ft}return Object(m.a)(e,[{key:"getWidth",value:function(){return this.ctx.canvas.width/window.devicePixelRatio}},{key:"getHeight",value:function(){return this.ctx.canvas.height/window.devicePixelRatio}},{key:"renderBorder",value:function(e,t,n,i){var a=10*n,r=20*n;if(this.ctx.strokeStyle="#666",1===i)this.ctx.strokeRect(e-1,t-1,a+2,r+2);else{var o=Math.min(2*i,1),s=t+r/2,c=s-(r/2+1)*o,l=s+(r/2+1)*o,h=Math.max(2*(i-.5),0),d=e+a/2*h,u=e+a-a/2*h;this.ctx.beginPath(),this.ctx.moveTo(e-1,c),this.ctx.lineTo(e-1,l),this.ctx.moveTo(e+a+1,c),this.ctx.lineTo(e+a+1,l),this.ctx.moveTo(e,t-1),this.ctx.lineTo(d,t-1),this.ctx.moveTo(e,t+r+1),this.ctx.lineTo(d,t+r+1),this.ctx.moveTo(e+a,t-1),this.ctx.lineTo(u,t-1),this.ctx.moveTo(e+a,t+r+1),this.ctx.lineTo(u,t+r+1),this.ctx.stroke()}}},{key:"renderGrid",value:function(e,t,n){var i=10*n,a=20*n;this.ctx.strokeStyle="#161616";for(var r=0;r<20;r++)this.ctx.beginPath(),this.ctx.moveTo(e,t+r*n),this.ctx.lineTo(e+i,t+r*n),this.ctx.stroke();for(var o=0;o<10;o++)this.ctx.beginPath(),this.ctx.moveTo(e+o*n,t),this.ctx.lineTo(e+o*n,t+a),this.ctx.stroke()}},{key:"renderActivePiece",value:function(e,t,n,i){var a,r=arguments.length>4&&void 0!==arguments[4]&&arguments[4],o=Object(et.a)(dt(i.pieceType,i.orientation));try{for(o.s();!(a=o.n()).done;){var s=a.value;this.ctx.fillStyle=r?ut(i.pieceType,.3):ut(i.pieceType);var c=i.position[1]+s[1],l=i.position[0]+s[0]-20;l>=0&&this.ctx.fillRect(e+c*n,t+l*n,n,n)}}catch(h){o.e(h)}finally{o.f()}}},{key:"renderLand",value:function(e,t,n,i){for(var a=20;a<40;a++)for(var r=0;r<10;r++){var o=i[a][r];0!==o&&(this.ctx.fillStyle=ut(o),this.ctx.fillRect(e+n*r,t+n*(a-20),n,n))}}},{key:"renderGameField",value:function(e,t,n,i,a,r){var o=r||{},s=null==o.borderCompleteness?1:o.borderCompleteness,c=null==o.showGrid||o.showGrid,l=null==o.fieldOpacity?1:o.fieldOpacity;if(this.renderBorder(e,t,n,s),c&&this.renderGrid(e,t,n),this.ctx.globalAlpha=l,this.renderLand(e,t,n,i),a){this.renderActivePiece(e,t,n,a);var h=function(e,t){for(var n=0;!vt(gt(e,[n,0]),t);)n++;return gt(e,[n-1,0])}(a,i);this.renderActivePiece(e,t,n,h,!0)}this.ctx.globalAlpha=1}},{key:"renderBagPreview",value:function(e,t,n,i){for(var a=0;a<Math.min(5,i.length);a++){var r=i[a];if("."===r)break;this.ctx.fillStyle=ut(r);var o,s=Object(et.a)(dt(r,0));try{for(s.s();!(o=s.n()).done;){var c=o.value;this.ctx.fillRect(e+c[1]*n,t+(3*a+c[0])*n,n,n)}}catch(l){s.e(l)}finally{s.f()}}}},{key:"renderHoldSlot",value:function(e,t,n,i,a){if(i){this.ctx.fillStyle=a?N.toString():ut(i);var r,o=Object(et.a)(dt(i,0));try{for(o.s();!(r=o.n()).done;){var s=r.value;this.ctx.fillRect(e+s[1]*n,t+s[0]*n,n,n)}}catch(c){o.e(c)}finally{o.f()}}}},{key:"renderGameFrame",value:function(e,t,n,i,a){a?(this.renderHoldSlot(e-n-i,t,n,a.hold,a.held),this.renderGameField(e+4*n,t,n,a.field,a.activePiece),this.renderBagPreview(e+14*n+i,t,n,a.nextPieces)):this.renderGrid(e+4*n,t,n)}},{key:"renderSelf",value:function(e){var t=28;22*t>this.getHeight()&&(t=20);var n=19*t+8,i=20*t;return this.renderGameFrame(this.getWidth()/2-n/2,this.getHeight()/2-i/2,t,4,e),n}},{key:"renderEnemy",value:function(e,t,n,i){var a=1,r=1;"joining"===i.animationType&&(a=Math.min(2.5*i.animationProgress,1),r=Math.max(1.67*(i.animationProgress-.4),0)),"disconnecting"===i.animationType&&(a=Math.min(1-2.5*(i.animationProgress-.6),1),r=Math.max(1-1.67*i.animationProgress,0)),this.renderGameField(e,t,n,i.field,i.activePiece,{showGrid:!1,borderCompleteness:a,fieldOpacity:r})}},{key:"renderEnemies",value:function(e){var t=this,n=new Set;for(var i in this.enemyStates)n.add(i);this.enemyGrid.setMaxEnemyWidth(.4*e),this.enemyGrid.update(n,this.getWidth(),this.getHeight(),e);var a=this.enemyGrid.getEnemyCoordinates(),r=Object(h.a)(a,2),o=r[0],s=r[1]/10;Object.entries(o).forEach((function(e){var n=Object(h.a)(e,2),i=n[0],a=n[1],r=t.enemyStates[i];t.renderEnemy(a[0],a[1],s,r)}))}},{key:"renderEverything",value:function(){this.ctx.clearRect(0,0,this.getWidth(),this.getHeight());var e=this.renderSelf(this.playerState);(this.getWidth()-e)/2>80&&this.getHeight()>80&&this.renderEnemies(e)}},{key:"updateFromServer",value:function(e,t){var n=this,i=function(i){if(i!==t)if(null==n.enemyStates[i])n.enemyStates[i]=Object(l.a)(Object(l.a)({},e.playerStates[i]),{},{animationType:"joining",animationProgress:0,tween:null}),n.enemyStates[i].tween=new pe.a.Tween(n.enemyStates[i]).to({animationProgress:1},1001).easing(pe.a.Easing.Quadratic.Out).onComplete((function(){n.enemyStates[i].animationType=null})).start();else for(var a in e.playerStates[i])n.enemyStates[i][a]=e.playerStates[i][a]};for(var a in e.playerStates)i(a);var r=function(t){var i=n.enemyStates[t];"disconnecting"!==i.animationType&&null==e.playerStates[t]&&(i.animationType="disconnecting",i.animationProgress=0,i.tween&&i.tween.stop(),i.tween=new pe.a.Tween(i).to({animationProgress:1},1001).easing(pe.a.Easing.Quadratic.Out).onComplete((function(){delete n.enemyStates[t]})).start())};for(var o in this.enemyStates)r(o)}},{key:"updateFromPrediction",value:function(e){this.playerState=e}}]),e}(),yt=37,wt=39,bt=38,xt=90,St=40,Ot=32,kt=67,Tt={},Et=p.a.div(ht||(ht=Object(d.a)(["\n  display: flex;\n  justify-content: center;\n  align-items: center;\n  height: 100vh;\n  width: 100vw;\n  flex-wrap: wrap;\n  background: black;\n"]))),jt=[];function Dt(){return(Dt=Object(Fe.a)(Me.a.mark((function e(){var t,n,i;return Me.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=new Go,console.log("fetching go"),e.next=4,WebAssembly.instantiateStreaming(fetch("main.wasm"),t.importObject);case 4:return n=e.sent,i=n.instance,console.log("finished fetching"),e.next=9,t.run(i);case 9:console.log("go program halted");case 10:case"end":return e.stop()}}),e)})))).apply(this,arguments)}var It,Ht=function(e){return Object(l.a)(Object(l.a)({},e),{},{activePiece:Object(l.a)(Object(l.a)({},e.activePiece),{},{position:[e.activePiece.position.row,e.activePiece.position.col]})})},Rt=function(e){return Object(l.a)(Object(l.a)({},e),{},{activePiece:e.activePiece?Object(l.a)(Object(l.a)({},e.activePiece),{},{position:{row:e.activePiece.position[0],col:e.activePiece.position[1]}}):void 0})},Wt=function(e){var t=Object(i.useRef)({serverState:{playerStates:{}},predictedStates:[null],inputHistory:[],actionIndex:0,clientID:void 0,frameStartTime:0,serverTimeOffset:0}),n=a.a.useRef(null),r=xe(),o=a.a.useRef(null);return a.a.useEffect((function(){if(null==n.current&&null!=o.current){var e=o.current.getContext("2d");e&&(n.current=new mt(e))}var i=function(e){if(!Tt[e.keyCode]){switch(e.keyCode){case yt:s(1);break;case wt:s(2);break;case bt:s(3);break;case xt:s(4);break;case St:s(5);break;case Ot:s(6);break;case kt:s(7)}Tt[e.keyCode]={downTime:Date.now(),lastTriggered:Date.now()}}},a=function(e){delete Tt[e.keyCode]};!function(){Dt.apply(this,arguments)}();var r=new WebSocket("ws://localhost:8080/socket");r.onopen=function(){r.onmessage=function(e){console.log("got message",e);var r,o=JSON.parse(e.data);if(o.messageType&&"id"===o.messageType)console.log("Got client ID",o.id),t.current.clientID=o.id,t.current.frameStartTime=o.time,t.current.serverTimeOffset=Date.now()-t.current.frameStartTime,window.setTimeout(c,17),window.addEventListener("keydown",i),window.addEventListener("keyup",a);else{var s=o.newState;r=s,s=Object(tt.a)(r,(function(e){for(var t=0,n=Object.keys(r.playerStates);t<n.length;t++){var i=n[t];e.playerStates[i]=Ht(r.playerStates[i])}})),function(e,t){if(null==e.clientID)throw new Error("clientID is null when reconciling server state");if(null==t.playerStates)throw new Error("server state is malformed: ".concat(t.playerStates));e.serverState=t;var n=e.serverState.playerStates[e.clientID];if(null!=n){var i=n.time;if((e.frameStartTime-i)%17!==0)throw new Error("frameStartTime ".concat(e.frameStartTime," and server update time ").concat(i," misaligned"));var a=e.predictedStates.length-1-(e.frameStartTime-i)/17;if(a<0)throw new Error("Received server update from before the last update (index ".concat(a,"); predictedStates is probably too short (length ").concat(e.predictedStates.length,")."));if(a>=e.predictedStates.length)console.log("Received server update from the future (index ".concat(a,"); predictedStates is probably lagging behind (length ").concat(e.predictedStates.length,"). Dropping update."));else{if(qe.isEqual(e.predictedStates[a],n))return console.log("Success: server state matches with client! Slicing predictedStates from index ".concat(a," to ").concat(e.predictedStates.length)),e.predictedStates=e.predictedStates.slice(a),void(e.inputHistory=e.inputHistory.slice(a));console.log("stringified predicted states",JSON.stringify(e.predictedStates)),console.log("Server state",n,"conflicts with client state",JSON.parse(JSON.stringify(e.predictedStates[a])),". Reconciling from index",a,"to",e.predictedStates.length),e.inputHistory=e.inputHistory.slice(a);var r=i;e.predictedStates=[n];var o,s=Object(et.a)(e.inputHistory);try{for(s.s();!(o=s.n()).done;){var c=o.value;r+=17;var l=e.predictedStates[e.predictedStates.length-1];if(null==l)throw new Error("last predicted state was null while reconciling");if("undefined"!=typeof updateGame){var h=updateGame(JSON.stringify(Rt(l)),JSON.stringify(c),r),d=Ht(JSON.parse(h));e.predictedStates.push(d)}else console.log("updateGame not ready at first reconciliation, pushing duplicated server state for now"),e.predictedStates.push(l)}}catch(u){s.e(u)}finally{s.f()}}}}(t.current,s),n.current&&t.current.clientID&&n.current.updateFromServer(t.current.serverState,t.current.clientID)}}};var s=function(e){var n={time:t.current.frameStartTime,command:e,index:t.current.actionIndex};jt.push(n),t.current.actionIndex++;var i=Object(l.a)({playerID:t.current.clientID},n);window.setTimeout((function(){r.send(JSON.stringify(i))}),500)},c=function e(){t.current.frameStartTime+=17,function(e,t){var n=e.predictedStates[e.predictedStates.length-1];if(null==n||"undefined"==typeof updateGame)return e.predictedStates.push(n),void e.inputHistory.push(t);var i=updateGame(JSON.stringify(Rt(n)),JSON.stringify(t),e.frameStartTime.toString()),a=Ht(JSON.parse(i));console.log("inputs",t),e.predictedStates.push(a),e.inputHistory.push(t)}(t.current,jt),n.current&&t.current.clientID&&n.current.updateFromPrediction(t.current.predictedStates[t.current.predictedStates.length-1]),jt=[];var i=Date.now(),a=Tt[wt];a&&i-a.downTime>=117&&i-a.lastTriggered>=22&&(s(2),a.lastTriggered===a.downTime?a.lastTriggered+=117:a.lastTriggered+=22);var r=Tt[yt];r&&i-r.downTime>=117&&i-r.lastTriggered>=22&&(s(1),r.lastTriggered===r.downTime?r.lastTriggered+=117:r.lastTriggered+=22);var o=Tt[St];o&&i-o.lastTriggered>=22&&(s(5),o.lastTriggered+=22);var c=t.current.frameStartTime+17-(Date.now()-t.current.serverTimeOffset);window.setTimeout(e,c)};requestAnimationFrame((function e(t){requestAnimationFrame(e),pe.a.update(t),n.current&&n.current.renderEverything()}))}),[]),a.a.useEffect((function(){r.width&&r.height&&S(o,r.width,r.height)}),[r]),a.a.createElement(Et,null,a.a.createElement("canvas",{style:{width:"100%",height:"100%",background:"black"},ref:o}))},At=function(e){return console.log("testpageprops",e),a.a.createElement(a.a.Fragment,null,"404 :(")},Ct=p.a.div(It||(It=Object(d.a)(["\n  padding: 16px;\n  font-family: Source Sans Pro;\n  outline: none;\n"]))),Pt=function(e){e.index;var t=e.block,n=a.a.useRef(null);return a.a.createElement("p",{className:"editor-block",id:t.id,ref:n},t.content)},Gt=function(e){var t=e.block,n="h".concat(t.level);return a.a.createElement(n,{id:t.id},t.content)};function _t(){return"".concat(Math.floor(1e7*Math.random()))}var Lt,Mt=function(){var e=a.a.useState([{type:"header",id:_t(),level:1,content:"A good day"},{type:"paragraph",id:_t(),content:"hello"},{type:"paragraph",id:_t(),content:"another paragraph"}]),t=Object(h.a)(e,2),n=t[0],i=t[1];console.log("STATE",n);var r=a.a.useCallback((function(e){console.log("step 0");var t=window.getSelection();if(null!=t){var a,r,o,s;if(console.log("step 1"),t.anchorNode instanceof Element)a=t.anchorNode;else a=null===(o=t.anchorNode)||void 0===o?void 0:o.parentElement;if(t.focusNode instanceof Element)r=t.focusNode;else r=null===(s=t.focusNode)||void 0===s?void 0:s.parentElement;if(null!=a&&null!=r){console.log("step 2");var c=a.closest(".editor-block"),l=r.closest(".editor-block");if(null!=c&&null!=l&&c===l){console.log("step 3",c,l);var h=c.id,d=qe.findIndex(n,(function(e){return e.id===h}));return void window.setTimeout((function(){var e=c.innerHTML;i((function(t){return Object(tt.b)(t,(function(t){t[d].content=function(e){return null==e?"":e}(e)}))}))}))}}}e.preventDefault()}),[n]);return a.a.createElement(Ct,{contentEditable:!0,onKeyDown:r,suppressContentEditableWarning:!0,onPaste:function(e){console.group("Pasted:");for(var t=e.clipboardData.items,n=function(n){var i=t[n],a={data:e.clipboardData.getData(i.type),asFile:i.getAsFile(),asEntry:i.webkitGetAsEntry()};i.getAsString((function(e){a.asString=e})),console.group("".concat(i.type," (").concat(i.kind,")")),console.log(a),console.groupEnd()},i=0;i<t.length;i++)n(i);console.groupEnd()}},n.map((function(e,t){var n;switch(e.type){case"header":n=Gt;break;case"paragraph":n=Pt}return a.a.createElement(n,{index:t,block:e,key:e.id})})))},Ft=function(){return a.a.createElement(Mt,null)},Nt=p.a.textarea(Lt||(Lt=Object(d.a)(["\n  padding: 16px;\n  font-family: Source Sans Pro;\n  outline: none;\n  border: none;\n  width: 100%;\n  min-height: 100vh;\n"]))),zt=function(){return a.a.createElement(Nt,{placeholder:"Paste anything here!",onPaste:function(e){console.group("Pasted:");for(var t=e.clipboardData.items,n=function(n){var i=t[n],a={data:e.clipboardData.getData(i.type),asFile:i.getAsFile(),asEntry:i.webkitGetAsEntry()};i.getAsString((function(e){a.asString=e})),console.group("".concat(i.type," (").concat(i.kind,")")),console.log(a),console.groupEnd()},i=0;i<t.length;i++)n(i);console.groupEnd()}})};var Qt=function(){return a.a.createElement(a.a.Fragment,null,a.a.createElement(s.a,null,a.a.createElement(c.c,null,a.a.createElement(c.a,{path:"/tetris",exact:!0,component:Wt}),a.a.createElement(c.a,{path:"/qlearning",exact:!0,component:_e}),a.a.createElement(c.a,{path:"/text",exact:!0,component:Ft}),a.a.createElement(c.a,{path:"/clipboard",exact:!0,component:zt}),a.a.createElement(c.a,{path:"/",exact:!0,component:Ze}),a.a.createElement(c.a,{component:At}))))};Boolean("localhost"===window.location.hostname||"[::1]"===window.location.hostname||window.location.hostname.match(/^127(?:\.(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)){3}$/));o.a.render(a.a.createElement(Qt,null),document.getElementById("root")),"serviceWorker"in navigator&&navigator.serviceWorker.ready.then((function(e){e.unregister()}))},72:function(e,t,n){e.exports=n(176)},77:function(e,t,n){},94:function(e,t){},95:function(e,t){},96:function(e,t){},97:function(e,t){},98:function(e,t){},99:function(e,t){}},[[72,1,2]]]);
//# sourceMappingURL=main.d6ecec7a.chunk.js.map
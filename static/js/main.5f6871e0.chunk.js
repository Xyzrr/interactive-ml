(this["webpackJsonpweb-app"]=this["webpackJsonpweb-app"]||[]).push([[0],{176:function(t,e,n){"use strict";n.r(e);var i=n(1),a=n.n(i),r=n(45),o=n.n(r),s=(n(77),n(67)),c=n(18),l=n(6),h=n(7),u=n(2),d=(n(78),n(19)),f=n.n(d),p=n(10),g=n(50),v=n(4),m=n(5);function y(t){return t.map((function(t,e){return[t,e]})).reduce((function(t,e){return e[0]>t[0]?e:t}))[1]}function w(t,e,n){for(var i=[],a=[];e--;)a.push(n);for(;t--;)i.push(a.slice());return i}function b(t){return t[0].map((function(e,n){return t.map((function(t){return t[n]}))}))}function x(t){return new Promise((function(e){return setTimeout(e,t)}))}function S(t,e,n){if(t.current){t.current.width=e*window.devicePixelRatio,t.current.height=n*window.devicePixelRatio;var i=t.current.getContext("2d");i&&i.scale(window.devicePixelRatio,window.devicePixelRatio)}}var O=function(){function t(e){Object(v.a)(this,t),this.gamma=void 0,this.lr=void 0,this.eps=void 0,this.epsDecay=void 0,this.qTable=void 0,this.updateData=void 0,e=Object(l.a)({gamma:.95,lr:.1,eps:.5,epsDecay:.99},e),this.gamma=e.gamma,this.lr=e.lr,this.eps=e.eps,this.epsDecay=e.epsDecay}return Object(m.a)(t,[{key:"prepareForEnv",value:function(t){this.qTable=function(t,e){for(var n=[],i=[];e--;)i.push(0);for(;t--;)n.push(i.slice());return n}(t.stateSpace,t.actionSpace)}},{key:"getAction",value:function(t){var e,n;if(null!=this.qTable)return Math.random()<this.eps?(e=0,n=this.qTable[0].length,Math.floor(Math.random()*(n-e))+e):y(this.qTable[t]);console.error("Q learning agent not prepared")}},{key:"update",value:function(t,e,n,i,a){null!=this.qTable?(this.updateData={state:t,action:e,lr:this.lr,reward:i,done:a,gamma:this.gamma,newState:n,nextAction:y(this.qTable[n]),currentQ:this.qTable[t][e],nextQ:Math.max.apply(Math,Object(g.a)(this.qTable[n]))},this.qTable[t][e]+=this.lr*(i+(a?0:this.gamma*Math.max.apply(Math,Object(g.a)(this.qTable[n])))-this.qTable[t][e])):console.error("Q learning agent not prepared")}},{key:"finishEpisode",value:function(){this.eps*=this.epsDecay}}]),t}(),k=n(11),T=n.n(k),E=T.a.rgb(10,10,10),j=T.a.rgb(110,110,110),D=T.a.rgb(200,200,200),I=(T.a.rgb(224,224,224),T.a.rgb(186,200,146)),H=T.a.rgb(78,201,176),R=T.a.rgb(156,220,254),W=T.a.rgb(86,156,214),A=T.a.rgb(250,138,84),C=T.a.rgb(197,134,192),P=T.a.rgb(220,220,170),G=T.a.rgb(206,145,120),_=T.a.rgb(255,165,0),L={state:C,nextState:W,reward:P,action:G,nextAction:H,currentQ:T.a.rgb(54,36,17),nextQ:T.a.rgb(17,54,31)},M=n(62),F=n.n(M);function N(){var t=Object(u.a)(["\n  color: ",";\n  font-size: ","px;\n"]);return N=function(){return t},t}var z=p.a.div(N(),D.toString(),(function(t){return t.fontSize})),Q=function(t){var e=F.a.renderToString(t.expression);return a.a.createElement(z,{fontSize:t.fontSize||20,dangerouslySetInnerHTML:{__html:e}})};function V(){var t=Object(u.a)(["\textcolor{","}{","}"],["\\textcolor{","}{","}"]);return V=function(){return t},t}function q(){var t=Object(u.a)(["colorbox{","}{$","$}"],["\\colorbox{","}{$","$}"]);return q=function(){return t},t}var U=function(t,e){return String.raw(q(),t.hex(),e)},B=function(t,e){return String.raw(V(),t.hex(),e)};function J(){var t=Object(u.a)(["\n        \begin{aligned}"," &leftarrow "," + alpha("," + gamma "," - ",") \\ \n        \n        "," &leftarrow "," + ","("," + "," "," - ",") \\ \n        \n        "," &leftarrow "," + ","("," + "," * "," - ",") \\\n\n        "," &leftarrow ","\n        end{aligned}"],["\n        \\begin{aligned}"," &\\leftarrow "," + \\alpha("," + \\gamma "," - ",") \\\\ \n        \n        "," &\\leftarrow "," + ","("," + "," "," - ",") \\\\ \n        \n        "," &\\leftarrow "," + ","("," + "," * "," - ",") \\\\\n\n        "," &\\leftarrow ","\n        \\end{aligned}"]);return J=function(){return t},t}function X(){var t=Object(u.a)(["Q(",", ",")"]);return X=function(){return t},t}function K(){var t=Object(u.a)(["max_{","}Q(",", ",")"],["\\max_{","}Q(",", ",")"]);return K=function(){return t},t}function $(){var t=Object(u.a)(["Q(",", ",")"]);return $=function(){return t},t}function Y(){var t=Object(u.a)(["Q(",", ",")"]);return Y=function(){return t},t}function Z(){var t=Object(u.a)(["\text{right}"],["\\text{right}"]);return Z=function(){return t},t}function tt(){var t=Object(u.a)(["\text{left}"],["\\text{left}"]);return tt=function(){return t},t}function et(){var t=Object(u.a)(["\text{right}"],["\\text{right}"]);return et=function(){return t},t}function nt(){var t=Object(u.a)(["\text{left}"],["\\text{left}"]);return nt=function(){return t},t}var it=function(t){var e=t.updateData;if(null==e)return a.a.createElement(a.a.Fragment,null);var n=e.action?String.raw(nt()):String.raw(et()),i=e.nextAction?String.raw(tt()):String.raw(Z()),r=U(L.currentQ,String.raw(Y(),B(L.state,"s"),B(L.action,"a"))),o=U(L.currentQ,String.raw($(),B(L.state,e.state.toString()),B(L.action,n))),s=U(L.nextQ,String.raw(K(),B(L.nextAction,"a'"),B(L.nextState,"s'"),B(L.nextAction,"a'"))),c=U(L.nextQ,String.raw(X(),B(L.nextState,e.newState.toString()),B(L.nextAction,i.toString())));return a.a.createElement("div",{style:{position:"fixed",left:t.position.x,top:t.position.y}},a.a.createElement(Q,{expression:String.raw(J(),r,r,B(L.reward,"r"),s,r,o,o,e.lr,B(L.reward,e.reward.toString()),e.gamma,c,o,o,U(L.currentQ,e.currentQ.toFixed(2)),e.lr,B(L.reward,e.reward.toString()),e.gamma,U(L.nextQ,e.nextQ.toFixed(2)),U(L.currentQ,e.currentQ.toFixed(2)),o,(e.currentQ+e.lr*(e.reward+e.gamma*e.nextQ-e.currentQ)).toFixed(2))}))};function at(){var t=Object(u.a)(["\n  position: fixed;\n  color: white;\n  padding: 4px 8px;\n  border-radius: 4px;\n  cursor: pointer;\n  user-select: none;\n  animation: "," 0.3s ease-out 1;\n"]);return at=function(){return t},t}function rt(){var t=Object(u.a)(["\n    from {\n        background: rgba(255, 255, 255, .5);\n    }\n    to {\n        background: rgba(0, 0, 0, 0);\n    }\n"]);return rt=function(){return t},t}var ot=Object(p.b)(rt()),st=p.a.div(at(),ot),ct=a.a.forwardRef((function(t,e){var n=a.a.useRef(null);return a.a.useImperativeHandle(e,(function(){return{click:function(){n.current&&(n.current.style.animation="none",n.current.offsetWidth,n.current.style.animation="")}}})),a.a.createElement(st,{style:{left:t.position.x,top:t.position.y,animation:"none"},onClick:t.onClick,ref:n},a.a.createElement(Q,{fontSize:16,expression:t.expression}))})),lt=function(){function t(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:5,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:.2,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:2,a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:10,r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:100;Object(v.a)(this,t),this.n=void 0,this.slip=void 0,this.small=void 0,this.large=void 0,this.episode_length=void 0,this.state=void 0,this.stepCount=void 0,this.stateSpace=void 0,this.actionSpace=void 0,this.n=e,this.slip=n,this.small=i,this.large=a,this.episode_length=r,this.state=0,this.stepCount=0,this.stateSpace=e,this.actionSpace=2}return Object(m.a)(t,[{key:"step",value:function(t){var e=!1;Math.random()<this.slip&&(t=!t,e=!0);var n=0;return t?(n=this.small,this.state=0):this.state<this.n-1?this.state+=1:n=this.large,this.stepCount+=1,console.log(this.stepCount),{newState:this.state,reward:n,done:this.stepCount>=this.episode_length,info:{slipped:e}}}},{key:"reset",value:function(){return this.state=0,this.stepCount=0,this.state}}]),t}(),ht=function(){function t(e,n){Object(v.a)(this,t),this.env=void 0,this.agent=void 0,this.state=void 0,this.prevState=void 0,this.lastReward=void 0,this.totalReward=0,this.lastAction=void 0,this.env=e,this.agent=n,this.reset()}return Object(m.a)(t,[{key:"reset",value:function(){this.state=this.env.reset(),this.prevState=void 0,this.totalReward=0}},{key:"agentTakeAction",value:function(t){var e=this.env.step(t),n=e.newState,i=e.reward,a=e.done,r=e.info;this.lastAction=t,this.lastReward=i,this.totalReward+=i,this.agent.update(this.state,t,n,i,a),this.prevState=this.state,this.state=n;var o=this.totalReward;return a&&(this.agent.finishEpisode(),this.reset()),{action:t,newState:n,reward:i,done:a,totalReward:o,info:r}}},{key:"step",value:function(){var t=this.agent.getAction(this.state);return this.agentTakeAction(t)}}]),t}();var ut=n(3),dt=function(){function t(e,n,i,a){Object(v.a)(this,t),this.canvas=e,this.ctx=n,this.size=i,this.sceneObjects=a}return Object(m.a)(t,[{key:"render",value:function(){var t=this;requestAnimationFrame(this.render.bind(this)),this.ctx.fillStyle=E,this.ctx.fillRect(0,0,this.size.width,this.size.height),this.sceneObjects.forEach((function(e){e.render(t.ctx,t.size)})),ut.a.update()}}]),t}(),ft=function(){function t(e){Object(v.a)(this,t),this.position=void 0,this.redness=void 0,this.position=e,this.redness=0}return Object(m.a)(t,[{key:"move",value:function(t){new ut.a.Tween(this.position).to({x:t},150).start()}},{key:"slip",value:function(){this.redness=1,new ut.a.Tween(this).to({redness:0},500).start()}},{key:"render",value:function(t){t.fillStyle=R,t.beginPath(),t.arc(this.position.x,this.position.y,20,0,2*Math.PI),t.fill(),t.fillStyle=A.fade(1-this.redness),t.fill()}}]),t}(),pt=function(){function t(e){Object(v.a)(this,t),this.RADIUS=30,this.DIST=100,this.position=e}return Object(m.a)(t,[{key:"highlightStates",value:function(t){this.highlightedStates=t}},{key:"render",value:function(t){var e=this;t.strokeStyle=j,t.lineWidth=1,t.beginPath();for(var n=0;n<5;n++)n<4&&(t.beginPath(),t.moveTo(this.position.x+this.DIST*(n-2)+this.RADIUS,this.position.y),t.lineTo(this.position.x+this.DIST*(n-1)-this.RADIUS,this.position.y)),t.stroke(),t.beginPath(),t.arc(this.position.x+this.DIST*(n-2),this.position.y,this.RADIUS,0,2*Math.PI),t.stroke(),t.font="16px KaTeX_Main",t.fillStyle=j.toString(),t.textAlign="center",t.fillText(n,this.position.x+this.DIST*(n-2),this.position.y+4);this.highlightedStates&&this.highlightedStates.forEach((function(n){t.beginPath(),t.strokeStyle=n.color.toString(),t.arc(e.position.x+e.DIST*(n.index-2),e.position.y,e.RADIUS,0,2*Math.PI),t.stroke(),t.font="16px KaTeX_Main",t.fillStyle=n.color.toString(),t.textAlign="center",t.fillText(n.index,e.position.x+e.DIST*(n.index-2),e.position.y+4)}))}}]),t}(),gt=function(){function t(){Object(v.a)(this,t),this.coins=new Set}return Object(m.a)(t,[{key:"emit",value:function(t,e){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,i={position:t,opacity:{val:0},fading:!1};this.coins.add(i),new ut.a.Tween(i.position).delay(n).to(e,200).easing(ut.a.Easing.Cubic.Out).start(),new ut.a.Tween(i.opacity).delay(n).to({val:.8},200).easing(ut.a.Easing.Cubic.Out).start()}},{key:"clear",value:function(){var t=this;this.coins.forEach((function(e){e.fading||(new ut.a.Tween(e.opacity).delay(250).to({val:0},400).onComplete((function(){return t.coins.delete(e)})).start(),e.fading=!0)}))}},{key:"render",value:function(t){this.coins.forEach((function(e){t.beginPath(),t.fillStyle=L.reward.fade(1-e.opacity.val).toString(),t.arc(e.position.x,e.position.y,6,0,2*Math.PI),t.fill()}))}}]),t}(),vt=function(){function t(e,n,i){Object(v.a)(this,t),i=Object(l.a)({font:"30px KaTeX_Main",textAlign:"center",precision:2,color:D,modifier:function(t){return t}},i),this.position=e,this.val=n,this.font=i.font,this.textAlign=i.textAlign,this.precision=i.precision,this.modifier=i.modifier,this.color=i.color,this.newVal=0,this.newValColor=A,this.newValOpacity=0,this.newValOffset=0,this.valOpacity=1,this.valOffset=0}return Object(m.a)(t,[{key:"onAnimationFinish",value:function(){this.activeTween=new ut.a.Tween(this).to({newValOpacity:0},2e3).start(),this.valOpacity=1,this.valOffset=0,this.val=this.newVal}},{key:"updateVal",value:function(t){var e=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:400;t!==this.newVal&&(this.activeTween&&this.activeTween.stop(),e||(this.val=t,this.newVal=t),t>this.val?(this.val=this.newVal,this.newVal=t,this.newValColor=I,this.valOpacity=1,this.newValOpacity=0,this.valOffset=0,this.newValOffset=-25,this.activeTween=new ut.a.Tween(this).to({valOpacity:0,newValOpacity:1,valOffset:25,newValOffset:0},n).onStop(this.onAnimationFinish.bind(this)).onComplete(this.onAnimationFinish.bind(this)).start()):t<this.val&&(this.val=this.newVal,this.newVal=t,this.newValColor=A,this.valOpacity=1,this.newValOpacity=0,this.valOffset=0,this.newValOffset=25,this.activeTween=new ut.a.Tween(this).to({valOpacity:0,newValOpacity:1,valOffset:-25,newValOffset:0},n).onStop(this.onAnimationFinish.bind(this)).onComplete(this.onAnimationFinish.bind(this)).start()))}},{key:"render",value:function(t){t.textAlign=this.textAlign,t.font=this.font,t.fillStyle=this.color.fade(1-this.valOpacity),null!=this.val&&t.fillText(this.modifier(this.val.toFixed(this.precision)),this.position.x,this.position.y+this.valOffset),t.fillStyle=this.newValColor.fade(1-this.newValOpacity),null!=this.newVal&&t.fillText(this.modifier(this.newVal.toFixed(this.precision)),this.position.x,this.position.y+this.newValOffset)}}]),t}(),mt=function(){function t(e,n){Object(v.a)(this,t),this.CELL_WIDTH=120,this.CELL_HEIGHT=70,this.numberObjects=void 0,this.position=void 0,this.highlightedCells=[],this.position=e,this.numberObjects=[];for(var i=0;i<n.length;i++){for(var a=[],r=0;r<n[0].length;r++)a.push(new vt(0,0,n[i][r]));this.numberObjects.push(a)}}return Object(m.a)(t,[{key:"updateData",value:function(t){for(var e=0;e<this.numberObjects.length;e++)for(var n=0;n<this.numberObjects[0].length;n++)this.numberObjects[e][n].updateVal(t[e][n])}},{key:"highlightCells",value:function(t){this.highlightedCells=t}},{key:"repositionNumbers",value:function(){for(var t=0;t<this.numberObjects.length;t++)for(var e=0;e<this.numberObjects[0].length;e++)this.numberObjects[t][e].position={x:this.position.x+this.CELL_WIDTH*(e+.5),y:this.position.y+45+this.CELL_HEIGHT*t}}},{key:"render",value:function(t){var e=this;t.lineWidth=1,this.repositionNumbers(),this.highlightedCells&&this.highlightedCells.forEach((function(n){t.beginPath(),t.fillStyle=n.color,t.fillRect(e.position.x+e.CELL_WIDTH*n.col,e.position.y+e.CELL_HEIGHT*n.row,e.CELL_WIDTH,e.CELL_HEIGHT)}));for(var n=0;n<this.numberObjects.length;n++)for(var i=0;i<this.numberObjects[0].length;i++)t.beginPath(),t.rect(this.position.x+this.CELL_WIDTH*i,this.position.y+this.CELL_HEIGHT*n,this.CELL_WIDTH,this.CELL_HEIGHT),t.strokeStyle=j.toString(),t.stroke(),this.numberObjects[n][i].render(t)}}]),t}();function yt(){var t="object"===typeof window,e=a.a.useCallback((function(){return{width:t?window.innerWidth:void 0,height:t?window.innerHeight:void 0}}),[t]),n=a.a.useState(e),i=Object(h.a)(n,2),r=i[0],o=i[1];return a.a.useEffect((function(){if(!t)return!1;function n(){o(e())}return window.addEventListener("resize",n),function(){return window.removeEventListener("resize",n)}}),[e,o,t]),r}function wt(){var t=Object(u.a)(["\text{left}"],["\\text{left}"]);return wt=function(){return t},t}function bt(){var t=Object(u.a)(["\text{right}"],["\\text{right}"]);return bt=function(){return t},t}function xt(){var t=Object(u.a)(["\n  background-color: ",";\n"]);return xt=function(){return t},t}var St={gamma:.95,lr:.1,eps:.5,epsDecay:.99},Ot=180,kt=450,Tt=new lt,Et=new O(St);Et.prepareForEnv(Tt);var jt=new ht(Tt,Et),Dt=new vt({x:kt,y:Ot-72},0,{textAlign:"center",font:"40px KaTeX_Main",precision:0}),It=new pt({x:kt,y:Ot}),Ht=new gt,Rt=new ft({x:kt-2*It.DIST,y:Ot}),Wt=new mt({x:kt-2.5*It.DIST,y:Ot+55},b(Et.qTable));Wt.CELL_WIDTH=It.DIST;var At=p.a.div(xt(),E.toString());var Ct=function(){var t=a.a.useRef(null),e=a.a.useRef(),n=yt(),i=a.a.useState(0),r=Object(h.a)(i,2),o=r[0],s=r[1],c=a.a.useState(Object(l.a)({autoPlay:!1},St)),u=Object(h.a)(c,2),p=u[0],g=u[1];!function(t){var e=a.a.useState(0),n=Object(h.a)(e,2),i=n[0],r=n[1];a.a.useEffect((function(){window.addEventListener("keypress",(function(e){switch(e.keyCode){case 110:t[i](),i<t.length-1&&r(i+1)}}))}))}([function(){window.alert("hello world")},function(){window.alert("hello world 2")}]);var v=function(t,e,n,i){t?T.current&&T.current.click():k.current&&k.current.click(),i.slipped&&Rt.slip(),e&&g(Object(l.a)(Object(l.a)({},p),{},{eps:Et.eps})),s(o+1)},m=function(){var t=jt.step(),e=t.action,n=t.done,i=(t.totalReward,t.info);v(e,n,0,i)},y=function(t){if(39===t.keyCode){t.preventDefault();var e=jt.agentTakeAction(0),n=e.done,i=(e.totalReward,e.info);v(0,n,0,i)}if(37===t.keyCode){t.preventDefault();var a=jt.agentTakeAction(1),r=a.done,o=(a.totalReward,a.info);v(1,r,0,o)}};if(a.a.useEffect((function(){var i=t.current,a=i&&i.getContext("2d");n.width&&n.height&&S(t,n.width,n.height),e.current=new dt(i,a,n,[Ht,It,Wt,Rt,Dt]),e.current.render()}),[n]),a.a.useEffect((function(){jt.reset()}),[]),a.a.useEffect((function(){return document.addEventListener("keydown",y),function(){document.removeEventListener("keydown",y)}})),p.autoPlay&&window.setTimeout(m,200),Et.gamma=p.gamma,Et.lr=p.lr,Et.eps=p.eps,Et.epsDecay=p.epsDecay,n.width&&n.height&&S(t,n.width,n.height),Rt.move(kt+It.DIST*((jt.state||0)-2)),window.setTimeout((function(){Et.qTable&&Wt.updateData(b(Et.qTable))}),500),window.setTimeout((function(){Dt.updateVal(jt.totalReward)}),150),Ht.clear(),jt.lastReward)for(var w=2===jt.lastReward?kt-2*It.DIST:kt+2*It.DIST,x=0;x<jt.lastReward;x++){var O=2*Math.random()*Math.PI;Ht.emit({x:w,y:Ot},{x:kt+40*Math.cos(O),y:Ot-85+40*Math.sin(O)},150+10*x)}Et.updateData&&(Wt.highlightCells([{row:Et.updateData.action,col:Et.updateData.state,color:L.currentQ},{row:Et.updateData.nextAction,col:Et.updateData.newState,color:L.nextQ}]),It.highlightStates([{index:Et.updateData.state,color:L.state},{index:Et.updateData.newState,color:L.nextState}]));var k=a.a.useRef(null),T=a.a.useRef(null);return a.a.createElement(At,null,a.a.createElement(f.a,{data:p,onUpdate:function(t){g(t)}},a.a.createElement(d.DatNumber,{path:"lr",label:"Learning rate (\u03b1)",min:0,max:1,step:.01}),a.a.createElement(d.DatNumber,{path:"eps",label:"Rnd chance (\u03b5)",min:0,max:1,step:.01}),a.a.createElement(d.DatNumber,{path:"gamma",label:"Discount rate (\u03b3)",min:0,max:1,step:.01}),a.a.createElement(d.DatNumber,{path:"epsDecay",label:"\u03b5 decay",min:0,max:1,step:.01}),a.a.createElement(d.DatBoolean,{path:"autoPlay",label:"Auto-play"}),a.a.createElement(d.DatButton,{label:"Step",onClick:m})),a.a.createElement("canvas",{style:{width:"100%",height:"100%",background:"black"},ref:t}),a.a.createElement(it,{updateData:Et.updateData,position:{x:kt-3*Wt.CELL_WIDTH-12,y:Wt.position.y+2*Wt.CELL_HEIGHT+30}}),a.a.createElement(ct,{ref:k,expression:B(Et.updateData&&0===Et.updateData.action?L.action:Et.updateData&&0===Et.updateData.nextAction?L.nextAction:D,String.raw(bt())),position:{x:kt-3*Wt.CELL_WIDTH-20,y:Wt.position.y+20},onClick:function(){var t=jt.agentTakeAction(0),e=t.done,n=(t.totalReward,t.info);v(0,e,0,n)}}),a.a.createElement(ct,{ref:T,expression:B(Et.updateData&&1===Et.updateData.action?L.action:Et.updateData&&1===Et.updateData.nextAction?L.nextAction:D,String.raw(wt())),position:{x:kt-3*Wt.CELL_WIDTH-20,y:Wt.position.y+1*Wt.CELL_HEIGHT+20},onClick:function(){var t=jt.agentTakeAction(1),e=t.done,n=(t.totalReward,t.info);v(1,e,0,n)}}))},Pt=n(12),Gt=n.n(Pt),_t=n(33),Lt=n(65),Mt=n.n(Lt),Ft=n(8),Nt=function(){function t(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:9,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:2,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:-1;Object(v.a)(this,t),this.boardSize=void 0,this.foodReward=void 0,this.deathReward=void 0,this.player=void 0,this.food=void 0,this.boardSize=e,this.foodReward=n,this.deathReward=i,this.reset()}return Object(m.a)(t,[{key:"playerOnFood",value:function(){return 2===this.player.gather(this.player.shape[0]).equal(this.food).sum().bufferSync().get(0)}},{key:"playerOutOfBounds",value:function(){var t=this.player.bufferSync(),e=t.get(this.player.shape[0]-1,0),n=t.get(this.player.shape[0]-1,1),i=!(0<=e&&e<this.boardSize&&0<=n&&n<this.boardSize);return i&&console.log("snake went out of bounds"),i}},{key:"collidedWithTail",value:function(){var t=Ft.f(this.player,[this.player.shape[0]-1,1]),e=Object(h.a)(t,2),n=e[0],i=e[1],a=2===Ft.g(n.equal(i),1).max().bufferSync().get(0);return a&&console.log("snake collided with tail"),a}},{key:"step",value:function(t){null==t&&console.log("Error: action was undefined in SnakeEnv!",t);var e=this.player.gather(this.player.shape[0]-1),n=[Ft.h([0,-1]),Ft.h([1,0]),Ft.h([0,1]),Ft.h([-1,0])],i=e.add(n[t]);this.player=this.player.concat(i.reshape([1,2]));var a=0;if(this.playerOnFood())a=this.foodReward,this.randomizeFood();else{var r=Ft.f(this.player,[1,this.player.shape[0]-1]),o=Object(h.a)(r,2)[1];this.player=o}var s=!1;return(this.playerOutOfBounds()||this.collidedWithTail())&&(s=!0,a=this.deathReward),s?{newObservation:Ft.i([this.boardSize,this.boardSize,3]),reward:a,done:s}:{newObservation:this.getObservation(),reward:a,done:s}}},{key:"getObservation",value:function(){var t=this.food.reverse().concat(Ft.h([0])),e=this.player.reverse(1).concat(Ft.a([this.player.shape[0]-1],2).concat(Ft.h([1])).reshape([this.player.shape[0],1]),1),n=t.reshape([1,3]).concat(e),i=Ft.h([1]).concat(Ft.d(1,this.player.shape[0])).concat(Ft.h([1]));return Ft.e(n,i,[this.boardSize,this.boardSize,3])}},{key:"randomizeFood",value:function(){for(;this.food=Ft.c([2],0,this.boardSize,"int32"),2===Ft.g(this.player.equal(this.food),1).max().bufferSync().get(0););}},{key:"reset",value:function(){return this.player=Ft.c([1,2],0,this.boardSize,"int32"),this.randomizeFood(),this.getObservation()}}]),t}(),zt=n(17);function Qt(){var t=Object(u.a)(["\n  height: 100%;\n  width: 100%;\n  display: flex;\n  flex-direction: column;\n  justify-content: center;\n  .row {\n    display: flex;\n    justify-content: center;\n    height: 60px;\n  }\n  .cell {\n    width: 60px;\n    height: 100%;\n    &.food {\n      background: ",";\n    }\n    &.snake,\n    &.tail {\n      background: ",";\n    }\n  }\n  @media (max-width: 768px) {\n    width: 100%;\n    .row {\n      height: ","vw;\n    }\n    .cell {\n      width: ","vw;\n    }\n  }\n"]);return Qt=function(){return t},t}var Vt=p.a.div(Qt(),A.desaturate(.3).hex(),I.desaturate(.5).hex(),100/9,100/9),qt=new Nt,Ut=qt.getObservation(),Bt={stopRunning:!1,disableInput:!1,modelUpdating:!1},Jt=function(t){var e=a.a.useState(Ut),n=Object(h.a)(e,2),i=n[0],r=n[1],o=a.a.useState(0),s=Object(h.a)(o,2),c=s[0],l=s[1];function u(t,e,n,i,a,r){return d.apply(this,arguments)}function d(){return(d=Object(_t.a)(Gt.a.mark((function t(e,n,i,a,r,o){var s,c,l,h;return Gt.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(!Bt.modelUpdating){t.next=2;break}return t.abrupt("return");case 2:return Bt.modelUpdating=!0,s=e.predict(n.reshape([1,9,9,3])),c=e.predict(a.reshape([1,9,9,3])),l=r+(o?0:.95*c.max().arraySync()),(h=s.bufferSync()).set(l,0,i),t.next=10,e.fit(n.reshape([1,9,9,3]),h.toTensor(),{epochs:1});case 10:Bt.modelUpdating=!1;case 11:case"end":return t.stop()}}),t)})))).apply(this,arguments)}console.log("Total reward:",c),a.a.useEffect((function(){function t(t){return e.apply(this,arguments)}function e(){return(e=Object(_t.a)(Gt.a.mark((function t(e){var n,i,a,o,s;return Gt.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:n=0;case 1:i=!1,a=void 0,a=0===n?qt.getObservation():qt.reset(),o=Gt.a.mark((function t(){var n,o,s,c,h,d;return Gt.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(!Bt.stopRunning){t.next=2;break}return t.abrupt("return",{v:void 0});case 2:return n=e.predict(a.reshape([1,9,9,3])),null==(o=n.argMax(1).arraySync()[0])&&(console.log("Error: action was undefined in runModel!",o),console.log("observation:"),a.print(),console.log("prediction:"),n.print(),console.log("argmax:"),console.log(n.argMax(1))),s=qt.step(o),c=s.newObservation,h=s.reward,d=s.done,r(c),l((function(t){return t+h})),t.next=10,u(e,a,o,c,h,i);case 10:return i=d,a=c,t.next=14,x(300);case 14:case"end":return t.stop()}}),t)}));case 5:if(i){t.next=12;break}return t.delegateYield(o(),"t0",7);case 7:if("object"!==typeof(s=t.t0)){t.next=10;break}return t.abrupt("return",s.v);case 10:t.next=5;break;case 12:n++,t.next=1;break;case 15:case"end":return t.stop()}}),t)})))).apply(this,arguments)}var n=zt.debounce((function(e){Bt.stopRunning=!1,Bt.disableInput=!1,t(e)}),600);Ft.b("/models/snake/model.json").then((function(e){e.compile({optimizer:"adam",loss:"meanSquaredError"}),t(e),window.addEventListener("keydown",(function(t){if(!Bt.disableInput){var i=qt.getObservation(),a={ArrowUp:0,ArrowRight:1,ArrowDown:2,ArrowLeft:3};if(t.key in a){var o=a[t.key],s=qt.step(o),c=s.newObservation,l=s.reward,h=s.done;r(c),Bt.stopRunning=!0,u(e,i,o,c,l,h),h&&(Bt.disableInput=!0,qt.reset()),n(e)}}}))}))}),[]);var f=i.arraySync();return a.a.createElement(Vt,null,f.map((function(t,e){return a.a.createElement("div",{className:"row",key:e},t.map((function(t,e){var n=1===t[0],i=1===t[1],r=t[2]>0;return a.a.createElement("div",{key:e,className:Mt()("cell",{food:n,snake:i,tail:r}),style:{opacity:n?.3:i?.4:r?.1+.3*(t[2]-1)/(qt.player.shape[0]-1):0}})})))})))};function Xt(){var t=Object(u.a)(["\n  position: absolute;\n  z-index: -1;\n  width: 100%;\n  height: 100%;\n"]);return Xt=function(){return t},t}function Kt(){var t=Object(u.a)(["\n  display: flex;\n  justify-content: center;\n  align-items: center;\n  height: 100%;\n  position: fixed;\n  width: 100%;\n  font-family: Quicksand;\n  .bio {\n    max-width: 400px;\n    width: 100%;\n    padding: 16px;\n    font-size: 18px;\n    margin-bottom: 80px;\n  }\n  .footer {\n    position: absolute;\n    right: 0;\n    bottom: 0;\n    padding: 16px;\n    font-size: 14px;\n    opacity: 0.6;\n    p {\n      margin: 0;\n    }\n  }\n  a {\n    color: black;\n    text-decoration: underline;\n    text-decoration-color: transparent;\n    font-weight: bold;\n    transition: all 0.15s;\n    &:hover {\n      text-decoration-color: black;\n    }\n  }\n"]);return Kt=function(){return t},t}for(var $t=p.a.div(Kt()),Yt=p.a.div(Xt()),Zt=function(t){console.log("props",t);var e={snake:{background:a.a.createElement(Jt,null),link:"https://github.com/Xyzrr/rl-snake",name:"DQN playing Snake"}},n=null;if(window.location.hash&&(n=window.location.hash.substr(1)),!n||!(n in e)){var i=Object.keys(e);n=i[Math.floor(Math.random()*i.length)]}var r=e[n];return a.a.createElement($t,null,a.a.createElement(Yt,null,r.background),a.a.createElement("div",{className:"bio"},a.a.createElement("p",null,"Hey, I'm John. "),a.a.createElement("p",null,"I currently do swe at"," ",a.a.createElement("a",{href:"https://wandb.com/"},"Weights & Biases"),". Earlier I moved buttons around at Google and dropped out of UIUC. I like simplifying and prettifying things,"," ",a.a.createElement("a",{href:"https://blog.johnqian.com"},"writing"),", and doing calisthenics. I idolize Paul Graham and Richard Feynman to an unreasonable extent."),a.a.createElement("p",null,"If you like my work, we should meet up. My email is johnlongqian (at) gmail.com.")),a.a.createElement("div",{className:"footer"},a.a.createElement("p",null,"Background:"),a.a.createElement("p",null,a.a.createElement("a",{href:r.link},r.name))))},te=n(14),ee=n(38),ne=n(66),ie=n.n(ne),ae=[[[0,0],[0,0],[0,0],[0,0],[0,0]],[[0,0],[0,1],[1,1],[-2,0],[-2,1]],[[0,0],[0,0],[0,0],[0,0],[0,0]],[[0,0],[0,-1],[1,-1],[-2,0],[-2,-1]]],re=[{color:I,minos:[[[1,2],[1,3],[2,1],[2,2]]],offsets:ae},{color:A,minos:[[[1,1],[1,2],[2,2],[2,3]]],offsets:ae},{color:W,minos:[[[1,1],[2,1],[2,2],[2,3]]],offsets:ae},{color:_,minos:[[[1,3],[2,1],[2,2],[2,3]]],offsets:ae},{color:C,minos:[[[1,2],[2,1],[2,2],[2,3]]],offsets:ae},{color:P,minos:[[[1,2],[1,3],[2,2],[2,3]]],offsets:[[[0,0]],[[1,0]],[[1,-1]],[[0,-1]]]},{color:R,minos:[[[2,1],[2,2],[2,3],[2,4]]],offsets:[[[0,0],[0,-1],[0,2],[0,-1],[0,2]],[[0,-1],[0,0],[0,0],[-1,0],[2,0]],[[-1,-1],[-1,1],[-1,-2],[0,1],[0,-2]],[[-1,0],[-1,0],[-1,0],[1,0],[-2,0]]]}],oe=function(t,e){var n,i=[],a=Object(te.a)(t);try{for(a.s();!(n=a.n()).done;){var r=n.value;i.push([r[1],e-r[0]-1])}}catch(o){a.e(o)}finally{a.f()}return i},se=1;se<8;se++)for(var ce=re[se-1],le=0;le<3;le++)ce.minos.push(oe(ce.minos[le],5));var he=function(t,e){return re[t-1].minos[e]},ue=ie()((function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1;return re[t-1].color.alpha(e).toString()}),{length:2}),de=function(){function t(){Object(v.a)(this,t),this.WIDTH_HEIGHT_RATIO=.5,this.GUTTER_WIDTH_RATIO=.2,this.enemies=new Set,this.fullWidth=0,this.fullHeight=0,this.gapWidth=0,this.maxEnemyWidth=void 0,this.grid=[],this.enemyWidth=0,this.animatedEnemyWidth=0,this.yOffset=0}return Object(m.a)(t,[{key:"setMaxEnemyWidth",value:function(t){this.maxEnemyWidth=t}},{key:"setEnemyWidth",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;this.enemyWidth=t,0===e?this.animatedEnemyWidth=t:new ut.a.Tween(this).to({animatedEnemyWidth:t},e).easing(ut.a.Easing.Quadratic.InOut).start()}},{key:"getOptimalDimensions",value:function(t){for(var e=arguments.length>1&&void 0!==arguments[1]&&arguments[1],n=this.getSideWidth(),i=0,a=0,r=1;;){var o=(i=n/(r+(r+1)*this.GUTTER_WIDTH_RATIO))/this.WIDTH_HEIGHT_RATIO,s=i*this.GUTTER_WIDTH_RATIO;if((a=Math.floor((this.fullHeight-s)/(o+s)))*r>=Math.ceil(t/2))break;r++}for(var c,l,h,u=0,d=0,f=1;;){var p=(u=this.fullHeight/(f+(f+1)*this.WIDTH_HEIGHT_RATIO*this.GUTTER_WIDTH_RATIO))*this.WIDTH_HEIGHT_RATIO,g=p*this.GUTTER_WIDTH_RATIO;if((d=Math.floor((n-g)/(p+g)))*f>=Math.ceil(t/2))break;f++}var v=u*this.WIDTH_HEIGHT_RATIO;return v>i?(c=v,l=f,h=e?2*Math.ceil(t/f/2):2*d):(c=i,l=e?a:Math.ceil(t/(2*r)),h=2*r),this.maxEnemyWidth&&c>this.maxEnemyWidth&&(c=this.maxEnemyWidth),[c,l,h]}},{key:"reshape",value:function(t){console.log("RESHAPING");var e=this.getOptimalDimensions(t.size),n=Object(h.a)(e,3),i=n[0],a=n[1],r=n[2];this.setEnemyWidth(i),this.grid=w(a,r,null),this.enemies=new Set,this.addNewEnemies(t)}},{key:"getGridCapacity",value:function(){return 0===this.grid.length?0:this.grid.length*this.grid[0].length}},{key:"expand",value:function(t){console.log("EXPANDING");for(var e=this.getOptimalDimensions(t),n=Object(h.a)(e,3),i=n[0],a=n[1],r=n[2],o=w(a,r,null),s=0;s<this.grid.length;s++)for(var c=0;c<this.grid[s].length;c++){var l=(r-this.grid[0].length)/2;o[s][c+l]=this.grid[s][c]}this.setEnemyWidth(i,1001),this.grid=o}},{key:"getGutterWidth",value:function(){return this.enemyWidth*this.GUTTER_WIDTH_RATIO}},{key:"getGridExpectedSideWidth",value:function(){if(0===this.grid.length)return 0;var t=this.grid[0].length/2;t:for(var e=0;e<this.grid[0].length/2;e++){for(var n=0;n<this.grid.length;n++)if(null!=this.grid[n][e]||null!=this.grid[n][this.grid[n].length-1-e])break t;t--}return this.enemyWidth*t+this.getGutterWidth()*(t+1)}},{key:"getGridExpectedHeight",value:function(){var t=this.grid.length;t:for(var e=this.grid.length-1;e>0;e--){for(var n=0;n<this.grid[e].length;n++)if(null!=this.grid[e][n])break t;t--}return this.enemyWidth/this.WIDTH_HEIGHT_RATIO*t+this.getGutterWidth()*(t+1)}},{key:"getSideWidth",value:function(){return(this.fullWidth-this.gapWidth)/2}},{key:"updateYOffset",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,e=this.getGridExpectedHeight(),n=(this.fullHeight-e)/2;0===t?this.yOffset=n:new ut.a.Tween(this).to({yOffset:n},t).easing(ut.a.Easing.Quadratic.InOut).start()}},{key:"removeMissingEnemies",value:function(t){for(var e in this.grid)for(var n in this.grid[e]){var i=this.grid[e][n];null==i||t.has(i)||(this.grid[e][n]=null)}}},{key:"addNewEnemies",value:function(t){var e=this.addPath(),n=e.next().value;console.error("ABC attempting with grid",zt.cloneDeep(this.grid)),console.error("enemies",this.enemies,t);var i,a=Object(te.a)(t);try{for(a.s();!(i=a.n()).done;){var r=i.value;if(!this.enemies.has(r)){for(;null!=this.grid[n[0]][n[1]];)n=e.next().value,console.error("ABC coord",n);this.grid[n[0]][n[1]]=r}}}catch(o){a.e(o)}finally{a.f()}}},{key:"sidePath",value:Gt.a.mark((function t(e){var n,i,a,r,o;return Gt.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(0!==this.grid.length){t.next=2;break}return t.abrupt("return");case 2:n="left"===e?this.grid[0].length/2-1:this.grid[0].length/2,i=0;case 4:if(!(i<Math.max(this.grid.length,this.grid[0].length))){t.next=28;break}if(a=void 0,!((a="left"===e?this.grid[0].length/2-1-i:this.grid[0].length/2+i)>=0&&a<this.grid[0].length)){t.next=16;break}r=0;case 9:if(!(r<i)){t.next=16;break}if(!(r<this.grid.length)){t.next=13;break}return t.next=13,[r,a];case 13:r++,t.next=9;break;case 16:if(!(i<this.grid.length)){t.next=25;break}o=n;case 18:if(!("left"===e?o>=a:o<=a)){t.next=25;break}if(!(o>=0&&o<this.grid[0].length)){t.next=22;break}return t.next=22,[i,o];case 22:o+="left"===e?-1:1,t.next=18;break;case 25:i++,t.next=4;break;case 28:case"end":return t.stop()}}),t,this)}))},{key:"addPath",value:Gt.a.mark((function t(){var e,n,i,a,r;return Gt.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:e=this.sidePath("left"),n=this.sidePath("right"),i=Object(te.a)(e),t.prev=3,i.s();case 5:if((a=i.n()).done){t.next=13;break}return r=a.value,t.next=9,r;case 9:return t.next=11,n.next().value;case 11:t.next=5;break;case 13:t.next=18;break;case 15:t.prev=15,t.t0=t.catch(3),i.e(t.t0);case 18:return t.prev=18,i.f(),t.finish(18);case 21:case"end":return t.stop()}}),t,this,[[3,15,18,21]])}))},{key:"update",value:function(t,e,n,i){if(console.log("GRID",this.grid),this.gapWidth=i,e!==this.fullWidth||n!==this.fullHeight)return this.fullWidth=e,this.fullHeight=n,this.reshape(t),this.updateYOffset(),void(this.enemies=t);zt.isEqual(this.enemies,t)||(this.removeMissingEnemies(t),t.size>this.getGridCapacity()&&this.expand(t.size),this.addNewEnemies(t),this.updateYOffset(0===this.enemies.size?0:2e3),this.enemies=t)}},{key:"getEnemyCoordinates",value:function(){for(var t={},e=this.fullWidth/2,n=0;n<this.grid.length;n++)for(var i=0;i<this.grid[n].length;i++){var a=this.grid[n][i];if(null!=a){var r=void 0;if(i>=this.grid[n].length/2){var o=i-this.grid[n].length/2;r=e+this.gapWidth/2+o*this.animatedEnemyWidth+(o+1)*this.getGutterWidth()}else{var s=this.grid[n].length/2-1-i;r=e-this.gapWidth/2-(s+1)*(this.animatedEnemyWidth+this.getGutterWidth())}var c=this.yOffset+n*(this.animatedEnemyWidth/this.WIDTH_HEIGHT_RATIO)+(n+1)*this.getGutterWidth();t[a]=[r,c]}}return[t,this.animatedEnemyWidth]}}]),t}(),fe=function(t,e){return[t[0]+e[0],t[1]+e[1]]},pe=function(t,e){return Object(l.a)(Object(l.a)({},t),{},{position:fe(t.position,e)})},ge=function(t,e){var n,i=he(t.pieceType,t.orientation),a=Object(te.a)(i);try{for(a.s();!(n=a.n()).done;){var r=n.value,o=fe(t.position,r);if(o[0]<0||o[0]>=40||o[1]<0||o[1]>=10||e[o[0]][o[1]])return!0}}catch(s){a.e(s)}finally{a.f()}return!1},ve=function(){function t(e){Object(v.a)(this,t),this.ctx=void 0,this.enemyGrid=void 0,this.enemyStates={},this.playerState=null,this.ctx=e,this.enemyGrid=new de}return Object(m.a)(t,[{key:"getWidth",value:function(){return this.ctx.canvas.width/window.devicePixelRatio}},{key:"getHeight",value:function(){return this.ctx.canvas.height/window.devicePixelRatio}},{key:"renderBorder",value:function(t,e,n,i){var a=10*n,r=20*n;if(this.ctx.strokeStyle="#666",1===i)this.ctx.strokeRect(t-1,e-1,a+2,r+2);else{var o=Math.min(2*i,1),s=e+r/2,c=s-(r/2+1)*o,l=s+(r/2+1)*o,h=Math.max(2*(i-.5),0),u=t+a/2*h,d=t+a-a/2*h;this.ctx.beginPath(),this.ctx.moveTo(t-1,c),this.ctx.lineTo(t-1,l),this.ctx.moveTo(t+a+1,c),this.ctx.lineTo(t+a+1,l),this.ctx.moveTo(t,e-1),this.ctx.lineTo(u,e-1),this.ctx.moveTo(t,e+r+1),this.ctx.lineTo(u,e+r+1),this.ctx.moveTo(t+a,e-1),this.ctx.lineTo(d,e-1),this.ctx.moveTo(t+a,e+r+1),this.ctx.lineTo(d,e+r+1),this.ctx.stroke()}}},{key:"renderGrid",value:function(t,e,n){var i=10*n,a=20*n;this.ctx.strokeStyle="#161616";for(var r=0;r<20;r++)this.ctx.beginPath(),this.ctx.moveTo(t,e+r*n),this.ctx.lineTo(t+i,e+r*n),this.ctx.stroke();for(var o=0;o<10;o++)this.ctx.beginPath(),this.ctx.moveTo(t+o*n,e),this.ctx.lineTo(t+o*n,e+a),this.ctx.stroke()}},{key:"renderActivePiece",value:function(t,e,n,i){var a,r=arguments.length>4&&void 0!==arguments[4]&&arguments[4],o=Object(te.a)(he(i.pieceType,i.orientation));try{for(o.s();!(a=o.n()).done;){var s=a.value;this.ctx.fillStyle=r?ue(i.pieceType,.3):ue(i.pieceType);var c=i.position[1]+s[1],l=i.position[0]+s[0]-20;l>=0&&this.ctx.fillRect(t+c*n,e+l*n,n,n)}}catch(h){o.e(h)}finally{o.f()}}},{key:"renderLand",value:function(t,e,n,i){for(var a=20;a<40;a++)for(var r=0;r<10;r++){var o=i[a][r];0!==o&&(this.ctx.fillStyle=ue(o),this.ctx.fillRect(t+n*r,e+n*(a-20),n,n))}}},{key:"renderGameField",value:function(t,e,n,i,a,r){var o=r||{},s=null==o.borderCompleteness?1:o.borderCompleteness,c=null==o.showGrid||o.showGrid,l=null==o.fieldOpacity?1:o.fieldOpacity;if(this.renderBorder(t,e,n,s),c&&this.renderGrid(t,e,n),this.ctx.globalAlpha=l,this.renderLand(t,e,n,i),a){this.renderActivePiece(t,e,n,a);var h=function(t,e){for(var n=0;!ge(pe(t,[n,0]),e);)n++;return pe(t,[n-1,0])}(a,i);this.renderActivePiece(t,e,n,h,!0)}this.ctx.globalAlpha=1}},{key:"renderBagPreview",value:function(t,e,n,i){for(var a=0;a<Math.min(5,i.length);a++){var r=i[a];if("."===r)break;this.ctx.fillStyle=ue(r);var o,s=Object(te.a)(he(r,0));try{for(s.s();!(o=s.n()).done;){var c=o.value;this.ctx.fillRect(t+c[1]*n,e+(3*a+c[0])*n,n,n)}}catch(l){s.e(l)}finally{s.f()}}}},{key:"renderHoldSlot",value:function(t,e,n,i,a){if(i){this.ctx.fillStyle=a?j.toString():ue(i);var r,o=Object(te.a)(he(i,0));try{for(o.s();!(r=o.n()).done;){var s=r.value;this.ctx.fillRect(t+s[1]*n,e+s[0]*n,n,n)}}catch(c){o.e(c)}finally{o.f()}}}},{key:"renderGameFrame",value:function(t,e,n,i,a){a?(this.renderHoldSlot(t-n-i,e,n,a.hold,a.held),this.renderGameField(t+4*n,e,n,a.field,a.activePiece),this.renderBagPreview(t+14*n+i,e,n,a.nextPieces)):this.renderGrid(t+4*n,e,n)}},{key:"renderSelf",value:function(t){var e=28;22*e>this.getHeight()&&(e=20);var n=19*e+8,i=20*e;return this.renderGameFrame(this.getWidth()/2-n/2,this.getHeight()/2-i/2,e,4,t),n}},{key:"renderEnemy",value:function(t,e,n,i){var a=1,r=1;"joining"===i.animationType&&(a=Math.min(2.5*i.animationProgress,1),r=Math.max(1.67*(i.animationProgress-.4),0)),"disconnecting"===i.animationType&&(a=Math.min(1-2.5*(i.animationProgress-.6),1),r=Math.max(1-1.67*i.animationProgress,0)),this.renderGameField(t,e,n,i.field,i.activePiece,{showGrid:!1,borderCompleteness:a,fieldOpacity:r})}},{key:"renderEnemies",value:function(t){var e=this,n=new Set;for(var i in this.enemyStates)n.add(i);this.enemyGrid.setMaxEnemyWidth(.4*t),this.enemyGrid.update(n,this.getWidth(),this.getHeight(),t);var a=this.enemyGrid.getEnemyCoordinates(),r=Object(h.a)(a,2),o=r[0],s=r[1]/10;Object.entries(o).forEach((function(t){var n=Object(h.a)(t,2),i=n[0],a=n[1],r=e.enemyStates[i];e.renderEnemy(a[0],a[1],s,r)}))}},{key:"renderEverything",value:function(){this.ctx.clearRect(0,0,this.getWidth(),this.getHeight());var t=this.renderSelf(this.playerState);(this.getWidth()-t)/2>80&&this.getHeight()>80&&this.renderEnemies(t)}},{key:"updateFromServer",value:function(t,e){var n=this,i=function(i){if(i!==e)if(null==n.enemyStates[i])n.enemyStates[i]=Object(l.a)(Object(l.a)({},t.playerStates[i]),{},{animationType:"joining",animationProgress:0,tween:null}),n.enemyStates[i].tween=new ut.a.Tween(n.enemyStates[i]).to({animationProgress:1},1001).easing(ut.a.Easing.Quadratic.Out).onComplete((function(){n.enemyStates[i].animationType=null})).start();else for(var a in t.playerStates[i])n.enemyStates[i][a]=t.playerStates[i][a]};for(var a in t.playerStates)i(a);var r=function(e){var i=n.enemyStates[e];"disconnecting"!==i.animationType&&null==t.playerStates[e]&&(i.animationType="disconnecting",i.animationProgress=0,i.tween&&i.tween.stop(),i.tween=new ut.a.Tween(i).to({animationProgress:1},1001).easing(ut.a.Easing.Quadratic.Out).onComplete((function(){delete n.enemyStates[e]})).start())};for(var o in this.enemyStates)r(o)}},{key:"updateFromPrediction",value:function(t){this.playerState=t}}]),t}();function me(){var t=Object(u.a)(["\n  display: flex;\n  justify-content: center;\n  align-items: center;\n  height: 100vh;\n  width: 100vw;\n  flex-wrap: wrap;\n  background: black;\n"]);return me=function(){return t},t}var ye=37,we=39,be=38,xe=90,Se=40,Oe=32,ke=67,Te={},Ee=p.a.div(me()),je=[];function De(){return(De=Object(_t.a)(Gt.a.mark((function t(){var e,n,i;return Gt.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return e=new Go,console.log("fetching go"),t.next=4,WebAssembly.instantiateStreaming(fetch("main.wasm"),e.importObject);case 4:return n=t.sent,i=n.instance,console.log("finished fetching"),t.next=9,e.run(i);case 9:console.log("go program halted");case 10:case"end":return t.stop()}}),t)})))).apply(this,arguments)}var Ie=function(t){return Object(l.a)(Object(l.a)({},t),{},{activePiece:Object(l.a)(Object(l.a)({},t.activePiece),{},{position:[t.activePiece.position.row,t.activePiece.position.col]})})},He=function(t){return Object(l.a)(Object(l.a)({},t),{},{activePiece:t.activePiece?Object(l.a)(Object(l.a)({},t.activePiece),{},{position:{row:t.activePiece.position[0],col:t.activePiece.position[1]}}):void 0})},Re=function(t){var e=Object(i.useRef)({serverState:{playerStates:{}},predictedStates:[null],inputHistory:[],actionIndex:0,clientID:void 0,frameStartTime:0,serverTimeOffset:0}),n=a.a.useRef(null),r=yt(),o=a.a.useRef(null);return a.a.useEffect((function(){if(null==n.current&&null!=o.current){var t=o.current.getContext("2d");t&&(n.current=new ve(t))}var i=function(t){if(!Te[t.keyCode]){switch(t.keyCode){case ye:s(1);break;case we:s(2);break;case be:s(3);break;case xe:s(4);break;case Se:s(5);break;case Oe:s(6);break;case ke:s(7)}Te[t.keyCode]={downTime:Date.now(),lastTriggered:Date.now()}}},a=function(t){delete Te[t.keyCode]};!function(){De.apply(this,arguments)}();var r=new WebSocket("ws://localhost:8080/socket");r.onopen=function(){r.onmessage=function(t){console.log("got message",t);var r,o=JSON.parse(t.data);if(o.messageType&&"id"===o.messageType)console.log("Got client ID",o.id),e.current.clientID=o.id,e.current.frameStartTime=o.time,e.current.serverTimeOffset=Date.now()-e.current.frameStartTime,window.setTimeout(c,17),window.addEventListener("keydown",i),window.addEventListener("keyup",a);else{var s=o.newState;r=s,s=Object(ee.a)(r,(function(t){for(var e=0,n=Object.keys(r.playerStates);e<n.length;e++){var i=n[e];t.playerStates[i]=Ie(r.playerStates[i])}})),function(t,e){if(null==t.clientID)throw new Error("clientID is null when reconciling server state");if(null==e.playerStates)throw new Error("server state is malformed: ".concat(e.playerStates));t.serverState=e;var n=t.serverState.playerStates[t.clientID];if(null!=n){var i=n.time;if((t.frameStartTime-i)%17!==0)throw new Error("frameStartTime ".concat(t.frameStartTime," and server update time ").concat(i," misaligned"));var a=t.predictedStates.length-1-(t.frameStartTime-i)/17;if(a<0)throw new Error("Received server update from before the last update (index ".concat(a,"); predictedStates is probably too short (length ").concat(t.predictedStates.length,")."));if(a>=t.predictedStates.length)console.log("Received server update from the future (index ".concat(a,"); predictedStates is probably lagging behind (length ").concat(t.predictedStates.length,"). Dropping update."));else{if(zt.isEqual(t.predictedStates[a],n))return console.log("Success: server state matches with client! Slicing predictedStates from index ".concat(a," to ").concat(t.predictedStates.length)),t.predictedStates=t.predictedStates.slice(a),void(t.inputHistory=t.inputHistory.slice(a));console.log("stringified predicted states",JSON.stringify(t.predictedStates)),console.log("Server state",n,"conflicts with client state",JSON.parse(JSON.stringify(t.predictedStates[a])),". Reconciling from index",a,"to",t.predictedStates.length),t.inputHistory=t.inputHistory.slice(a);var r=i;t.predictedStates=[n];var o,s=Object(te.a)(t.inputHistory);try{for(s.s();!(o=s.n()).done;){var c=o.value;r+=17;var l=t.predictedStates[t.predictedStates.length-1];if(null==l)throw new Error("last predicted state was null while reconciling");if("undefined"!=typeof updateGame){var h=updateGame(JSON.stringify(He(l)),JSON.stringify(c),r),u=Ie(JSON.parse(h));t.predictedStates.push(u)}else console.log("updateGame not ready at first reconciliation, pushing duplicated server state for now"),t.predictedStates.push(l)}}catch(d){s.e(d)}finally{s.f()}}}}(e.current,s),n.current&&e.current.clientID&&n.current.updateFromServer(e.current.serverState,e.current.clientID)}}};var s=function(t){var n={time:e.current.frameStartTime,command:t,index:e.current.actionIndex};je.push(n),e.current.actionIndex++;var i=Object(l.a)({playerID:e.current.clientID},n);window.setTimeout((function(){r.send(JSON.stringify(i))}),500)},c=function t(){e.current.frameStartTime+=17,function(t,e){var n=t.predictedStates[t.predictedStates.length-1];if(null==n||"undefined"==typeof updateGame)return t.predictedStates.push(n),void t.inputHistory.push(e);var i=updateGame(JSON.stringify(He(n)),JSON.stringify(e),t.frameStartTime.toString()),a=Ie(JSON.parse(i));console.log("inputs",e),t.predictedStates.push(a),t.inputHistory.push(e)}(e.current,je),n.current&&e.current.clientID&&n.current.updateFromPrediction(e.current.predictedStates[e.current.predictedStates.length-1]),je=[];var i=Date.now(),a=Te[we];a&&i-a.downTime>=117&&i-a.lastTriggered>=22&&(s(2),a.lastTriggered===a.downTime?a.lastTriggered+=117:a.lastTriggered+=22);var r=Te[ye];r&&i-r.downTime>=117&&i-r.lastTriggered>=22&&(s(1),r.lastTriggered===r.downTime?r.lastTriggered+=117:r.lastTriggered+=22);var o=Te[Se];o&&i-o.lastTriggered>=22&&(s(5),o.lastTriggered+=22);var c=e.current.frameStartTime+17-(Date.now()-e.current.serverTimeOffset);window.setTimeout(t,c)};requestAnimationFrame((function t(e){requestAnimationFrame(t),ut.a.update(e),n.current&&n.current.renderEverything()}))}),[]),a.a.useEffect((function(){r.width&&r.height&&S(o,r.width,r.height)}),[r]),a.a.createElement(Ee,null,a.a.createElement("canvas",{style:{width:"100%",height:"100%",background:"black"},ref:o}))},We=function(t){return console.log("testpageprops",t),a.a.createElement(a.a.Fragment,null,"404 :(")};function Ae(){var t=Object(u.a)(["\n  padding: 16px;\n  font-family: Source Sans Pro;\n  outline: none;\n"]);return Ae=function(){return t},t}var Ce=p.a.div(Ae()),Pe=function(t){t.index;var e=t.block,n=a.a.useRef(null);return a.a.createElement("p",{className:"editor-block",id:e.id,ref:n},e.content)},Ge=function(t){var e=t.block,n="h".concat(e.level);return a.a.createElement(n,{id:e.id},e.content)};function _e(){return"".concat(Math.floor(1e7*Math.random()))}var Le=function(){var t=a.a.useState([{type:"header",id:_e(),level:1,content:"A good day"},{type:"paragraph",id:_e(),content:"hello"},{type:"paragraph",id:_e(),content:"another paragraph"}]),e=Object(h.a)(t,2),n=e[0],i=e[1];console.log("STATE",n);var r=a.a.useCallback((function(t){console.log("step 0");var e=window.getSelection();if(null!=e){var a,r,o,s;if(console.log("step 1"),e.anchorNode instanceof Element)a=e.anchorNode;else a=null===(o=e.anchorNode)||void 0===o?void 0:o.parentElement;if(e.focusNode instanceof Element)r=e.focusNode;else r=null===(s=e.focusNode)||void 0===s?void 0:s.parentElement;if(null!=a&&null!=r){console.log("step 2");var c=a.closest(".editor-block"),l=r.closest(".editor-block");if(null!=c&&null!=l&&c===l){console.log("step 3",c,l);var h=c.id,u=zt.findIndex(n,(function(t){return t.id===h}));return void window.setTimeout((function(){var t=c.innerHTML;i((function(e){return Object(ee.b)(e,(function(e){e[u].content=function(t){return null==t?"":t}(t)}))}))}))}}}t.preventDefault()}),[n]);return a.a.createElement(Ce,{contentEditable:!0,onKeyDown:r,suppressContentEditableWarning:!0,onPaste:function(t){console.group("Pasted:");for(var e=t.clipboardData.items,n=function(n){var i=e[n],a={data:t.clipboardData.getData(i.type),asFile:i.getAsFile(),asEntry:i.webkitGetAsEntry()};i.getAsString((function(t){a.asString=t})),console.group("".concat(i.type," (").concat(i.kind,")")),console.log(a),console.groupEnd()},i=0;i<e.length;i++)n(i);console.groupEnd()}},n.map((function(t,e){var n;switch(t.type){case"header":n=Ge;break;case"paragraph":n=Pe}return a.a.createElement(n,{index:e,block:t,key:t.id})})))},Me=function(){return a.a.createElement(Le,null)};function Fe(){var t=Object(u.a)(["\n  padding: 16px;\n  font-family: Source Sans Pro;\n  outline: none;\n  border: none;\n  width: 100%;\n  min-height: 100vh;\n"]);return Fe=function(){return t},t}var Ne=p.a.textarea(Fe()),ze=function(){return a.a.createElement(Ne,{placeholder:"Paste anything here!",onPaste:function(t){console.group("Pasted:");for(var e=t.clipboardData.items,n=function(n){var i=e[n],a={data:t.clipboardData.getData(i.type),asFile:i.getAsFile(),asEntry:i.webkitGetAsEntry()};i.getAsString((function(t){a.asString=t})),console.group("".concat(i.type," (").concat(i.kind,")")),console.log(a),console.groupEnd()},i=0;i<e.length;i++)n(i);console.groupEnd()}})};var Qe=function(){return a.a.createElement(a.a.Fragment,null,a.a.createElement(s.a,null,a.a.createElement(c.c,null,a.a.createElement(c.a,{path:"/tetris",exact:!0,component:Re}),a.a.createElement(c.a,{path:"/qlearning",exact:!0,component:Ct}),a.a.createElement(c.a,{path:"/text",exact:!0,component:Me}),a.a.createElement(c.a,{path:"/clipboard",exact:!0,component:ze}),a.a.createElement(c.a,{path:"/",exact:!0,component:Zt}),a.a.createElement(c.a,{component:We}))))};Boolean("localhost"===window.location.hostname||"[::1]"===window.location.hostname||window.location.hostname.match(/^127(?:\.(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)){3}$/));o.a.render(a.a.createElement(Qe,null),document.getElementById("root")),"serviceWorker"in navigator&&navigator.serviceWorker.ready.then((function(t){t.unregister()}))},72:function(t,e,n){t.exports=n(176)},77:function(t,e,n){},94:function(t,e){},95:function(t,e){},96:function(t,e){},97:function(t,e){},98:function(t,e){},99:function(t,e){}},[[72,1,2]]]);
//# sourceMappingURL=main.5f6871e0.chunk.js.map